events {
    worker_connections 1024;
}

http {
    # 업스트림 서버 정의
    upstream frontend {
        server frontend:3000;
    }

    upstream backend {
        server backend:8000;
    }

    upstream chat {
        server chat-server:3001;
    }

    # 로그 설정
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # 기본 설정
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;

    # Gzip 압축
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;

    # Cloudflare SSL 사용 전제: Origin(Nginx)은 HTTP(80)만 오픈해도 됨
    # (Cloudflare SSL 모드가 Full/Strict이면 Origin cert를 따로 세팅해야 함)
    server {
        listen 80;
        server_name _;

        # =========================
        # Maintenance mode (점검 모드)
        # =========================
        # - enable:  docker exec -it chapter8_nginx sh -lc "touch /etc/nginx/maintenance_on && nginx -s reload"
        # - disable: docker exec -it chapter8_nginx sh -lc "rm -f /etc/nginx/maintenance_on && nginx -s reload"
        #
        # 예상 완료 시간/공지 문구는 아래 JSON 파일로 입력(빌드 없이 즉시 반영)
        # - set: docker exec -it chapter8_nginx sh -lc 'cat > /etc/nginx/maintenance_info.json <<EOF
        # {"until":"2025-12-24 03:00 KST","message":"더 안정적인 서비스를 위해 점검 중입니다."}
        # EOF'
        # - clear: docker exec -it chapter8_nginx sh -lc "rm -f /etc/nginx/maintenance_info.json"
        #
        # 구현 방식:
        # - 프론트(React) 요청만 503으로 전환하고, error_page로 /maintenance(SPA 라우트) 콘텐츠를 보여준다.
        # - /maintenance는 예외 처리(무한 루프 방지).
        error_page 503 /maintenance;

        # 점검 안내 데이터(JSON) - MaintenancePage에서 fetch로 읽는다.
        # 파일이 없으면 404로 내려가고, 프론트는 기본 문구만 보여준다.
        location = /maintenance-info.json {
            default_type application/json;
            add_header Cache-Control "no-store";
            root /etc/nginx;
            try_files /maintenance_info.json =404;
        }

        # 점검 페이지(SPA 라우트)는 점검 가드에서 제외해야 한다.
        location = /maintenance {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket 지원(일관성)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # 프론트엔드 (React 앱)
        location / {
            # ✅ 점검 모드가 켜져 있으면 503 → error_page로 /maintenance 렌더링
            if (-f /etc/nginx/maintenance_on) {
                return 503;
            }
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket 지원
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # API 요청
        location /api/ {
            proxy_pass http://backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 타임아웃 설정
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # 정적 파일 (업로드된 파일)
        location /static/ {
            proxy_pass http://backend/static/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 캐싱 설정
            expires 7d;
            add_header Cache-Control "public";
        }

        # Socket.IO 연결
        location /socket.io/ {
            proxy_pass http://chat;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket 타임아웃
            proxy_read_timeout 86400;
        }

        # 정적 파일 캐싱
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            proxy_pass http://frontend;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}


