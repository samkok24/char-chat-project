# 결제 게이트 메모 (2026-02-20)

## 확정 결정사항
- 무료 기본 모델은 `Gemini Flash`로 고정한다.
- 유료 모델(예: `Haiku 4.5` 포함)은 유료 턴이 있을 때만 사용 가능하다.
- 무료 턴은 전역 지갑 방식으로 운영한다.
- 무료 턴은 `1시간당 1턴` 자동 충전한다.
- 메인 우상단에 `루비 수량 + 결제 아이콘 + 다음 충전 타이머`를 표시한다.
- `rerun(재생성)`은 과금 대상이다(무료 턴/유료 턴 모두 차감).
- 스트리밍 실패 시(`finish` 미도달, 네트워크 단절, 서버 에러) 턴 차감하지 않는다.
- 유료 모델 사용 중 잔여 유료 턴이 없으면 서버/프론트 모두 즉시 `free 모델`로 자동 전환한다.

## 정책 우선순위 (차감/복구)
1. 요청 시작 시 차감 예약(락/멱등키 기반).
2. 스트림 `finish` 성공 시 최종 차감 확정.
3. 스트림 실패/중단 시 차감 복구(무료/유료 동일 규칙).

## 구현 체크리스트
- 서버:
  - 차감 예약/확정/복구 상태머신 추가.
  - `rerun`을 일반 전송과 동일 과금 파이프라인으로 통합.
  - 유료 턴 부족 시 모델 강등(`free`)을 응답 메타로 명시.
  - 타이머 계산용 `next_refill_at`, `free_turn_balance`, `paid_turn_balance` API 제공.
- 프론트:
  - 우상단 잔액/타이머 UI 추가.
  - 유료 모델 선택 후 잔액 부족 시 구매 유도 후 자동 free 전환 UI 동기화.
  - 스트리밍 실패 시 낙관적 차감 UI 롤백.
  - 룸 진입/복귀/새로고침 시 서버 잔액 SSOT 재동기화.

## 모호한 부분(결정 필요)
- 무료 턴 최대 보유치(cap)를 둘지 여부(예: 24턴, 48턴, 무제한).
- 무료 턴 충전을 오프라인 시간까지 누적할지 여부.
- 유료 턴과 무료 턴 동시 보유 시 기본 소모 우선순위(유료 우선 vs 무료 우선).
- 자동 free 전환 시 구매 모달 강제 노출 여부(항상/선택/빈도 제한).
- 타이머 표기 기준(서버 시간 기준 고정 vs 클라이언트 카운트다운 + 주기적 보정).

## 피드백
- 지금 단계의 최우선은 채팅 체감속도(SSE 구조개선)다. 결제 게이트는 그 위에 얹는 것이 맞다.
- 과금 신뢰성은 UI가 아니라 서버 상태머신(차감 확정/복구)에서 보장해야 한다.
- 자동 free 전환은 “서버 결정 + 프론트 반영” 2단 구조로 가야 불일치를 막을 수 있다.
