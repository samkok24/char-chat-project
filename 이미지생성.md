### 대표이미지 1~n장 생성 기능 기획서 (캐릭터/웹소설/원작챗)

- **목표**
  - **대표이미지와 미니갤러리**를 손쉽게 생성·관리(배치 생성, 대표 지정, 삭제, 정렬)
  - 캐릭터/웹소설/원작챗 상세에서 **오너만** 사용 가능, 생성 과정과 결과가 UI에 즉시 반영

- **대상 엔티티**
  - **캐릭터(Character)**, **웹소설(Story)**, **원작챗(OrigChat Character)**

### UX 플로우

- **엔트리 포인트**: 각 상세페이지 상단 우측에 "대표이미지 생성" 버튼(오너 전용)
- **생성 모달(ImageGenerateModal)**
  - 프롬프트 프리필
    - 캐릭터: 이름/설명/성격/말투/세계관 요약
    - 웹소설: 제목/소개/요약(또는 발췌)
    - 원작챗: 캐릭터 정보 + 원작 세계관
  - 옵션
    - 개수: 1~8(기본 4)
    - 스타일: realistic | anime | painterly (확장 가능)
    - 비율: 1:1, 3:4(기본), 16:9
    - 시드/변주: seed, variation strength
    - 네거티브 프롬프트(선택)
  - 진행
    - 제출 → 작업 생성(job) → **스켈레톤 그리드** 표시 → 2~3초 간격 **폴링**으로 썸네일 점진 로딩
    - 실패/부분실패는 **집계 토스트**로 안내(성공 n, 실패 m)
  - 완료 후 조작
    - 각 썸네일에 [대표 지정][삭제][크롭] 아이콘
    - 대표 1장 고정, 드래그 정렬(모바일은 위/아래 버튼)

- **갤러리 노출**
  - 상세 상단: 대표이미지
  - 본문: 미니갤러리(최대 6), 클릭 시 확대 뷰어
  - 카드/그리드: 대표이미지 즉시 반영(react-query invalidate)

- **접근성/반응형**
  - 키보드 포커스 이동, aria 속성(`aria-selected`, `aria-busy`)
  - 모바일 1열, 데스크톱 3~4열 그리드

### 데이터 모델/저장

- 단일 테이블: `media_assets`
  - `id`, `entity_type`(character|story|origchat), `entity_id`
  - `url`, `width`, `height`, `is_primary`, `order_index`
  - `status`(pending|ready|failed), `provider`, `seed`, `style`, `ratio`
  - `phash`(유사 중복 방지, 선택), `created_at`
- 엔티티 컬럼 보강(비파괴)
  - `avatar_url`(대표 링크), `gallery_count`, `representative_image_version`(선택)

### 백엔드 API 설계(권한: 오너만 생성/정렬/삭제, 조회는 공개 상태에 따름)

- 생성/잡
  - POST `/media/generate` → { job_id }
    - body: { entity_type, entity_id, count, prompt, negative_prompt?, style?, ratio?, seed? }
  - GET `/media/jobs/{job_id}` → { status, progress, results:[{asset_id, url}] }

- 조회/관리
  - GET `/{entity}/{id}/images` → [{ id, url, is_primary, order_index, status }]
  - PATCH `/{entity}/{id}/images/{asset_id}/primary` → 대표 지정
  - PATCH `/{entity}/{id}/images/order` → { ids:[...] } 정렬 저장
  - DELETE `/{entity}/{id}/images/{asset_id}`

### 생성 엔진/인프라

- **모듈화 인터페이스**: Stable Diffusion/SDXL/FLUX/DALL·E 등 교체 가능
- **비동기 처리**: RQ/Celery + Redis 큐, 결과는 DB 저장 후 S3 업로드(프리사인 URL)
- **콘텐츠 가드**: NSFW/저작권 위험 필터링 → 차단/경고 + 실패 처리
- **비용/크레딧**: 장당 차감(설정값), 실패/차단 시 자동 환불

### 프런트 구현

- 컴포넌트: `ImageGenerateModal`
  - 상태: generating, progress, results, errors(partial)
  - 폴링: 2~3s, 완료/실패 시 중단, 취소 버튼 제공
  - 썸네일 셀: 대표/삭제/크롭 아이콘, 드래그 정렬
- 상세 헤더: "대표이미지 생성" 버튼(오너만 렌더)
- 캐시 무효화: 생성/대표지정/삭제/정렬 후 `['character', id] | ['story', id]` 등 invalidate

### 정책/제한

- 배치 개수 최대 8, 동시 작업 1(엔티티별), 1일 생성 한도(예: 24장)
- 이미지 출력 기본 1024px, 업스케일 옵션은 2단계로 뒤에 추가
- 프롬프트 프리셋 저장/불러오기(선택)

### 완료 기준(DoD)

- 오너가 1~8장 생성 → 갤러리에 썸네일이 순차 노출되고 대표 지정/삭제/정렬 가능
- 카드/탐색/Top 섹션의 대표이미지가 즉시 갱신
- 부분 실패 집계 토스트·재시도 동작
- 비오너에게 버튼 미노출, API 권한/레이트 제한 정상
- 접근성(키보드/스크린리더)과 모바일 레이아웃 정상

### QA 체크리스트

- [ ] 1장/8장/혼합 실패 케이스에서 UI 상태 일관
- [ ] 대표 지정 후 뒤로가기/새로고침에서도 유지
- [ ] 삭제/정렬 취소 시 서버 상태와 동기화
- [ ] 긴 프롬프트/한글/이모지 입력 안전 처리
- [ ] 콘텐츠 가드 차단 시 메시지와 환불 처리 확인

### 향후 확장

- 변주(Variation) 모드, 업스케일/리터치, 스타일 프리셋 마켓
- 이미지 캡션/태깅 자동화 → 검색 고도화
- 워터마크/라이선스 옵션


