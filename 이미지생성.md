### 대표이미지 1~n장 생성 기능 기획서 (캐릭터/웹소설/원작챗)

- **목표**
  - **대표이미지와 미니갤러리**를 손쉽게 생성·관리(배치 생성, 대표 지정, 삭제, 정렬)
  - 캐릭터/웹소설/원작챗 상세에서 **오너만** 사용 가능, 생성 과정과 결과가 UI에 즉시 반영

- **대상 엔티티**
  - **캐릭터(Character)**, **웹소설(Story)**, **원작챗(OrigChat Character)**

### UX 플로우

- **엔트리 포인트**: 각 상세페이지 상단 우측에 "대표이미지 생성" 버튼(오너 전용)
- **생성 모달(ImageGenerateModal)**
  - 프롬프트 프리필
    - 캐릭터: 이름/설명/성격/말투/세계관 요약
    - 웹소설: 제목/소개/요약(또는 발췌)
    - 원작챗: 캐릭터 정보 + 원작 세계관
  - 옵션
    - 개수: 1~8(기본 4)
    - 스타일: realistic | anime | painterly (확장 가능)
    - 비율: 1:1, 3:4(기본), 16:9
    - 시드/변주: seed, variation strength
    - 네거티브 프롬프트(선택)
  - 진행
    - 제출 → 작업 생성(job) → **스켈레톤 그리드** 표시 → 2~3초 간격 **폴링**으로 썸네일 점진 로딩
    - 실패/부분실패는 **집계 토스트**로 안내(성공 n, 실패 m)
  - 완료 후 조작
    - 각 썸네일에 [대표 지정][삭제][크롭] 아이콘
    - 대표 1장 고정, 드래그 정렬(모바일은 위/아래 버튼)

- **상세페이지 전용 “이미지 생성/삽입” 모달**
  - 목적: 생성뿐 아니라 기존 자산/업로드/URL을 즉시 갤러리에 “삽입”하고, 필요 시 대표로 교체
  - 탭 구조: [생성하기] | [삽입하기]
    - 생성하기: 위 “생성 모달”과 동일 옵션 + “삽입 방식” 선택(대표로 교체 | 갤러리에 추가 | 선택 후 삽입)
    - 삽입하기: 3가지 소스
      1) 내 자산(최근 생성/업로드한 이미지 라이브러리) – 다중 선택, 미리보기, 검색/필터(엔진/스타일/비율)
      2) 파일 업로드 – 다중 파일 드롭, 업로드 후 자동 검사(NSFW/해상도), 통과분만 첨부
      3) URL 붙여넣기 – 공개 이미지 URL 검사 후 프록시 저장(or 직접 첨부)
  - 배치 정책:
    - “대표로 교체” 체크 시 기존 대표를 갤러리 첫 번째로 내리고 새 이미지를 대표로 승격
    - “선택 후 삽입” 모드: 생성 결과 그리드에서 체크박스로 일부만 삽입
  - 크롭/비율
    - 추천 비율(1:1, 3:4, 16:9) 프리셋 + 자유 크롭, 포커스 포인트(얼굴/중심) 자동 제안
  - 가드/중복
    - pHash 유사 이미지 경고, NSFW/저작권 위험 차단 항목은 삽입 불가(사유 노출)
  - 비용/피드백
    - 생성 탭에 예상 크레딧/소요시간 표시, 부분 실패 집계 토스트, 재시도 버튼
  - 키보드/모바일
    - Grid 내 방향키/스페이스 선택, 모바일은 두 단(상단 옵션, 하단 그리드)로 스택

- **갤러리 노출**
  - 상세 상단: 대표이미지
  - 본문: 미니갤러리(최대 6), 클릭 시 확대 뷰어
  - 카드/그리드: 대표이미지 즉시 반영(react-query invalidate)

- **접근성/반응형**
  - 키보드 포커스 이동, aria 속성(`aria-selected`, `aria-busy`)
  - 모바일 1열, 데스크톱 3~4열 그리드

### 데이터 모델/저장

- 단일 테이블: `media_assets`
  - `id`, `entity_type`(character|story|origchat), `entity_id`
  - `url`, `width`, `height`, `is_primary`, `order_index`
  - `status`(pending|ready|failed), `provider`, `seed`, `style`, `ratio`
  - `phash`(유사 중복 방지, 선택), `created_at`
- 엔티티 컬럼 보강(비파괴)
  - `avatar_url`(대표 링크), `gallery_count`, `representative_image_version`(선택)

### 백엔드 API 설계(권한: 오너만 생성/정렬/삭제, 조회는 공개 상태에 따름)

- 생성/잡
  - POST `/media/generate` → { job_id }
    - body: { entity_type, entity_id, count, prompt, negative_prompt?, style?, ratio?, seed? }
  - GET `/media/jobs/{job_id}` → { status, progress, results:[{asset_id, url}] }

- 조회/관리
  - GET `/{entity}/{id}/images` → [{ id, url, is_primary, order_index, status }]
  - PATCH `/{entity}/{id}/images/{asset_id}/primary` → 대표 지정
  - PATCH `/{entity}/{id}/images/order` → { ids:[...] } 정렬 저장
  - DELETE `/{entity}/{id}/images/{asset_id}`

- 삽입/업로드(신규)
  - POST `/{entity}/{id}/images/attach` → 기존 `asset_id`들을 연결(내 자산/URL로 생성된 자산)
  - POST `/media/upload` → 다중 파일 업로드 후 [{asset_id, url}] 반환(NSFW/중복 검사 포함)
  - POST `/media/generate` with `auto_attach=true, attach_as=primary|gallery, select_mode=all|manual`
  - POST `/{entity}/{id}/images/replace-primary` body: { asset_id } → 대표 교체(이전 대표는 갤러리로 이동)

### 생성 엔진/인프라

- **모듈화 인터페이스**: Stable Diffusion/SDXL/FLUX/DALL·E 등 교체 가능
- **비동기 처리**: RQ/Celery + Redis 큐, 결과는 DB 저장 후 S3 업로드(프리사인 URL)
- **콘텐츠 가드**: NSFW/저작권 위험 필터링 → 차단/경고 + 실패 처리
- **비용/크레딧**: 장당 차감(설정값), 실패/차단 시 자동 환불

### 프런트 구현

- 컴포넌트: `ImageGenerateModal`
  - 상태: generating, progress, results, errors(partial)
  - 폴링: 2~3s, 완료/실패 시 중단, 취소 버튼 제공
  - 썸네일 셀: 대표/삭제/크롭 아이콘, 드래그 정렬
- 컴포넌트: `ImageInsertModal`(혹은 동일 모달 내 탭)
  - 탭: 생성하기 | 삽입하기
  - 삽입 탭: 내 자산/업로드/URL – 다중 선택 + 미리보기 + 즉시 붙이기
  - 삽입 결과: 곧바로 대표 교체 or 갤러리 추가, 실시간 반영
- 상세 헤더: "대표이미지 생성" 버튼(오너만 렌더)
- 캐시 무효화: 생성/대표지정/삭제/정렬 후 `['character', id] | ['story', id]` 등 invalidate

### 정책/제한

- 배치 개수 최대 8, 동시 작업 1(엔티티별), 1일 생성 한도(예: 24장)
- 이미지 출력 기본 1024px, 업스케일 옵션은 2단계로 뒤에 추가
- 프롬프트 프리셋 저장/불러오기(선택)

### 완료 기준(DoD)

- 오너가 1~8장 생성 → 갤러리에 썸네일이 순차 노출되고 대표 지정/삭제/정렬 가능
- 삽입 탭에서 내 자산/업로드/URL로 추가 시 즉시 갤러리/대표 반영
- 카드/탐색/Top 섹션의 대표이미지가 즉시 갱신
- 부분 실패 집계 토스트·재시도 동작
- 비오너에게 버튼 미노출, API 권한/레이트 제한 정상
- 접근성(키보드/스크린리더)과 모바일 레이아웃 정상

### QA 체크리스트

- [ ] 1장/8장/혼합 실패 케이스에서 UI 상태 일관
- [ ] 대표 지정 후 뒤로가기/새로고침에서도 유지
- [ ] 삭제/정렬 취소 시 서버 상태와 동기화
- [ ] 삽입 탭: 업로드/URL 첨부 후 즉시 반영 및 오류 처리
- [ ] 긴 프롬프트/한글/이모지 입력 안전 처리
- [ ] 콘텐츠 가드 차단 시 메시지와 환불 처리 확인

### 향후 확장

- 변주(Variation) 모드, 업스케일/리터치, 스타일 프리셋 마켓
- 이미지 캡션/태깅 자동화 → 검색 고도화
- 워터마크/라이선스 옵션


