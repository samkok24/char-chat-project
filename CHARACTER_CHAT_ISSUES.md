# ğŸ› ì¼ë°˜ ìºë¦­í„°ì±— ë¬¸ì œ ìš”ì†Œ ë¶„ì„

> ë°°í¬ ì „ ì¼ë°˜ ìºë¦­í„°ì±— ìƒì„±ë¶€í„° ìš´ì˜ê¹Œì§€ì˜ ë¬¸ì œ ìš”ì†Œ ì ê²€

## ğŸ“‹ í”Œë¡œìš° ê°œìš”

1. **ìºë¦­í„° ìƒì„±** â†’ 2. **ì±„íŒ… ì‹œì‘** â†’ 3. **ë©”ì‹œì§€ ì „ì†¡** â†’ 4. **AI ì‘ë‹µ ìƒì„±** â†’ 5. **ë©”ì‹œì§€ ì €ì¥/ì¡°íšŒ**

---

## ğŸ”´ ë°œê²¬ëœ ë¬¸ì œ ìš”ì†Œ

### 1. ì±„íŒ… ì‹œì‘ ì‹œ ì¸ì‚¬ë§ ì²˜ë¦¬ ë¬¸ì œ

**ìœ„ì¹˜**: `backend-api/app/api/chat.py:875-897`

**ë¬¸ì œì **:
```python
# 893ì¤„: greetingì´ Noneì´ê±°ë‚˜ ë¹ˆ ë¬¸ìì—´ì¼ ë•Œ ì²˜ë¦¬ ì•ˆë¨
await chat_service.save_message(
    db, chat_room.id, "assistant", chat_room.character.greeting
)
```

**ì˜í–¥**:
- `character.greeting`ì´ `None`ì´ë©´ ë¹ˆ ë©”ì‹œì§€ê°€ ì €ì¥ë¨
- ì‚¬ìš©ìê°€ ì±„íŒ…ë°©ì— ë“¤ì–´ì™”ì„ ë•Œ ì¸ì‚¬ë§ì´ ì—†ì–´ì„œ í˜¼ë€
- `_merge_character_tokens`ì—ì„œë„ `None` ì²˜ë¦¬ ì•ˆë¨ (75ì¤„)

**í•´ê²° í•„ìš”**:
- `greeting`ì´ ì—†ì„ ë•Œ ê¸°ë³¸ ì¸ì‚¬ë§ ìƒì„± ë˜ëŠ” ìŠ¤í‚µ
- `None` ì²´í¬ ì¶”ê°€

---

### 2. CharacterSetting ìƒì„± ì‹œ í•˜ë“œì½”ë”©ëœ ëª¨ë¸ëª…

**ìœ„ì¹˜**: `backend-api/app/api/chat.py:1218-1227`

**ë¬¸ì œì **:
```python
# 1222ì¤„: í•˜ë“œì½”ë”©ëœ 'gemini-pro' ëª¨ë¸ëª…
settings = CharacterSetting(
    character_id=character.id,
    ai_model='gemini-pro',  # âŒ í•˜ë“œì½”ë”©
    temperature=0.7,
    max_tokens=300
)
```

**ì˜í–¥**:
- ì‚¬ìš©ìì˜ `preferred_model` ì„¤ì •ì„ ë¬´ì‹œí•¨
- ì‚¬ìš©ìê°€ Claudeë¥¼ ì„ í˜¸í•´ë„ Geminië¡œ ê°•ì œë¨
- API í‚¤ê°€ ì—†ì„ ë•Œ ì—ëŸ¬ ë°œìƒ ê°€ëŠ¥

**í•´ê²° í•„ìš”**:
- ì‚¬ìš©ìì˜ `preferred_model` ì‚¬ìš©
- ë˜ëŠ” ì‹œìŠ¤í…œ ê¸°ë³¸ê°’ ì‚¬ìš© (ì„¤ì •ì—ì„œ ê´€ë¦¬)

---

### 3. AI API í‚¤ ê²€ì¦ ë¶€ì¡±

**ìœ„ì¹˜**: `backend-api/app/services/ai_service.py`

**ë¬¸ì œì **:
- `get_gemini_completion`: API í‚¤ê°€ ì—†ìœ¼ë©´ ëŸ°íƒ€ì„ ì—ëŸ¬ë§Œ ë°œìƒ (1243ì¤„)
- `get_claude_completion`: API í‚¤ê°€ ì—†ìœ¼ë©´ ëŸ°íƒ€ì„ ì—ëŸ¬ë§Œ ë°œìƒ (1352ì¤„)
- `get_ai_chat_response`: ëª¨ë¸ ì„ íƒ í›„ API í‚¤ í™•ì¸ ì•ˆí•¨ (1464ì¤„)

**ì˜í–¥**:
- API í‚¤ê°€ ì—†ì„ ë•Œ ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ ì—†ìŒ
- ì‚¬ìš©ìì—ê²Œ í˜¼ë€ìŠ¤ëŸ¬ìš´ ì—ëŸ¬ í‘œì‹œ
- ì–´ë–¤ API í‚¤ê°€ í•„ìš”í•œì§€ ì•Œ ìˆ˜ ì—†ìŒ

**í•´ê²° í•„ìš”**:
- API í˜¸ì¶œ ì „ í‚¤ ê²€ì¦
- ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ ë°˜í™˜
- ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ìë™ ê°ì§€

---

### 4. message_count ì—…ë°ì´íŠ¸ ì•ˆë¨

**ìœ„ì¹˜**: `backend-api/app/services/chat_service.py:80-102`

**ë¬¸ì œì **:
```python
# save_message í•¨ìˆ˜ì—ì„œ message_count ì—…ë°ì´íŠ¸ ì•ˆí•¨
async def save_message(...):
    chat_message = ChatMessage(...)
    db.add(chat_message)
    # âŒ ChatRoom.message_count ì—…ë°ì´íŠ¸ ì—†ìŒ
    await db.commit()
```

**ì˜í–¥**:
- `ChatRoom.message_count`ê°€ ì‹¤ì œ ë©”ì‹œì§€ ìˆ˜ì™€ ë¶ˆì¼ì¹˜
- í†µê³„/ë¶„ì„ì— ë¶€ì •í™•í•œ ë°ì´í„°
- ì„±ëŠ¥ ìµœì í™”ì— ë¬¸ì œ (ë©”ì‹œì§€ ìˆ˜ ê¸°ë°˜ ì¿¼ë¦¬)

**í•´ê²° í•„ìš”**:
- `save_message`ì—ì„œ `message_count` ì¦ê°€
- ë˜ëŠ” íŠ¸ë¦¬ê±°/ì´ë²¤íŠ¸ë¡œ ìë™ ì—…ë°ì´íŠ¸

---

### 5. AI ì‘ë‹µì´ Noneì¼ ë•Œ ì²˜ë¦¬ ë¶€ì¡±

**ìœ„ì¹˜**: `backend-api/app/api/chat.py:1376-1379`

**ë¬¸ì œì **:
```python
# 1377ì¤„: ai_response_textê°€ Noneì´ê±°ë‚˜ ë¹ˆ ë¬¸ìì—´ì¼ ìˆ˜ ìˆìŒ
ai_message = await chat_service.save_message(
    db, room.id, "assistant", ai_response_text
)
```

**ì˜í–¥**:
- ë¹ˆ ì‘ë‹µì´ ì €ì¥ë¨
- ì‚¬ìš©ìì—ê²Œ ë¹ˆ ë©”ì‹œì§€ í‘œì‹œ
- ì¬ì‹œë„ ë¡œì§ ì—†ìŒ

**í•´ê²° í•„ìš”**:
- ì‘ë‹µ ê²€ì¦ ì¶”ê°€
- ë¹ˆ ì‘ë‹µ ì‹œ ì¬ì‹œë„ ë˜ëŠ” ê¸°ë³¸ ë©”ì‹œì§€
- ì—ëŸ¬ ë©”ì‹œì§€ ì €ì¥

---

### 6. ì—ëŸ¬ í•¸ë“¤ë§ ë¶€ì¡±

**ìœ„ì¹˜**: `backend-api/app/api/chat.py:send_message`

**ë¬¸ì œì **:
- AI ì‘ë‹µ ìƒì„± ì‹¤íŒ¨ ì‹œ ì „ì²´ íŠ¸ëœì­ì…˜ ë¡¤ë°± ì•ˆë¨
- ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” ì €ì¥ë˜ì—ˆëŠ”ë° AI ì‘ë‹µë§Œ ì‹¤íŒ¨í•˜ëŠ” ê²½ìš°
- ë¶€ë¶„ ì‹¤íŒ¨ ìƒí™© ì²˜ë¦¬ ì•ˆë¨

**ì˜í–¥**:
- ë°ì´í„° ë¶ˆì¼ì¹˜ ê°€ëŠ¥ì„±
- ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” ë³´ì´ëŠ”ë° ì‘ë‹µì´ ì—†ëŠ” ìƒí™©
- ì¬ì‹œë„ ì‹œ ì¤‘ë³µ ë©”ì‹œì§€ ê°€ëŠ¥ì„±

**í•´ê²° í•„ìš”**:
- íŠ¸ëœì­ì…˜ ê´€ë¦¬ ê°œì„ 
- ë¶€ë¶„ ì‹¤íŒ¨ ì²˜ë¦¬
- ì¬ì‹œë„ ë¡œì§ ê°œì„ 

---

### 7. í”„ë¡ íŠ¸ì—”ë“œ ì—ëŸ¬ ì²˜ë¦¬

**ìœ„ì¹˜**: `frontend/char-chat-frontend/src/pages/ChatPage.jsx`

**ë¬¸ì œì **:
- AI ì‘ë‹µì´ ì—†ì„ ë•Œ ê¸°ë³¸ê°’ `'...'` ì‚¬ìš© (317ì¤„)
- ì—ëŸ¬ ë©”ì‹œì§€ê°€ ì‚¬ìš©ì ì¹œí™”ì ì´ì§€ ì•ŠìŒ
- ì¬ì‹œë„ ë¡œì§ì´ ìˆì§€ë§Œ ì‚¬ìš©ì í™•ì¸ í•„ìš” (886ì¤„)

**ì˜í–¥**:
- ì‚¬ìš©ì ê²½í—˜ ì €í•˜
- ì—ëŸ¬ ì›ì¸ íŒŒì•… ì–´ë ¤ì›€
- ìë™ ì¬ì‹œë„ ì—†ìŒ

**í•´ê²° í•„ìš”**:
- ë” ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€
- ìë™ ì¬ì‹œë„ ë¡œì§
- ë¡œë”© ìƒíƒœ ê°œì„ 

---

### 8. ìºë¦­í„° ì •ë³´ ê²€ì¦ ë¶€ì¡±

**ìœ„ì¹˜**: `backend-api/app/api/chat.py:start_chat`

**ë¬¸ì œì **:
- ìºë¦­í„°ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ ì•ˆí•¨
- ìºë¦­í„°ê°€ ë¹„í™œì„±í™”(`is_active=False`)ì¸ì§€ í™•ì¸ ì•ˆí•¨
- ìºë¦­í„°ê°€ ì‚­ì œë˜ì—ˆëŠ”ì§€ í™•ì¸ ì•ˆí•¨

**ì˜í–¥**:
- ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìºë¦­í„°ì™€ ì±„íŒ… ì‹œë„ ê°€ëŠ¥
- ë¹„í™œì„±í™”ëœ ìºë¦­í„°ì™€ ì±„íŒ… ê°€ëŠ¥
- ë°ì´í„° ë¬´ê²°ì„± ë¬¸ì œ

**í•´ê²° í•„ìš”**:
- ìºë¦­í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
- `is_active` ì²´í¬
- ì‚­ì œëœ ìºë¦­í„° ì²˜ë¦¬

---

### 9. ë™ì‹œì„± ë¬¸ì œ

**ìœ„ì¹˜**: `backend-api/app/api/chat.py:send_message`

**ë¬¸ì œì **:
- ë™ì¼í•œ ì‚¬ìš©ìê°€ ë™ì‹œì— ì—¬ëŸ¬ ë©”ì‹œì§€ ì „ì†¡ ì‹œ ìˆœì„œ ë³´ì¥ ì•ˆë¨
- `message_count` ì—…ë°ì´íŠ¸ ì‹œ race condition ê°€ëŠ¥
- ì±„íŒ…ë°© ìƒì„± ì‹œ ì¤‘ë³µ ìƒì„± ê°€ëŠ¥ì„±

**ì˜í–¥**:
- ë©”ì‹œì§€ ìˆœì„œ ë’¤ë°”ë€œ
- ì¹´ìš´íŠ¸ ë¶ˆì¼ì¹˜
- ì¤‘ë³µ ì±„íŒ…ë°© ìƒì„±

**í•´ê²° í•„ìš”**:
- íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ ì¡°ì •
- ë½ ë©”ì»¤ë‹ˆì¦˜ ì¶”ê°€
- ë©±ë“±ì„± ë³´ì¥

---

### 10. ë©”ëª¨ë¦¬/ì„±ëŠ¥ ë¬¸ì œ

**ìœ„ì¹˜**: `backend-api/app/api/chat.py:send_message`

**ë¬¸ì œì **:
- íˆìŠ¤í† ë¦¬ë¥¼ í•­ìƒ ìµœê·¼ 50ê°œ ê°€ì ¸ì˜´ (1343ì¤„)
- ê¸´ íˆìŠ¤í† ë¦¬ë¡œ ì¸í•œ í”„ë¡¬í”„íŠ¸ ê¸¸ì´ ì¦ê°€
- í† í° ì‚¬ìš©ëŸ‰ ì¦ê°€ë¡œ ë¹„ìš© ì¦ê°€

**ì˜í–¥**:
- ëŠë¦° ì‘ë‹µ ì‹œê°„
- ë†’ì€ API ë¹„ìš©
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€

**í•´ê²° í•„ìš”**:
- íˆìŠ¤í† ë¦¬ ê¸¸ì´ ë™ì  ì¡°ì •
- ìš”ì•½ëœ íˆìŠ¤í† ë¦¬ ì‚¬ìš©
- ìºì‹± ì „ëµ ê°œì„ 

---

## ğŸ“Š ìš°ì„ ìˆœìœ„ë³„ ì •ë¦¬

### ğŸ”´ Critical (ì¦‰ì‹œ ìˆ˜ì • í•„ìš”)

1. **ì¸ì‚¬ë§ None ì²˜ë¦¬** - ì‚¬ìš©ì ê²½í—˜ì— ì§ì ‘ ì˜í–¥
2. **AI API í‚¤ ê²€ì¦** - ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ê°€ëŠ¥ì„±
3. **AI ì‘ë‹µ None ì²˜ë¦¬** - ë¹ˆ ë©”ì‹œì§€ ì €ì¥ ë°©ì§€

### ğŸŸ¡ High (ë°°í¬ ì „ ìˆ˜ì • ê¶Œì¥)

4. **CharacterSetting ëª¨ë¸ëª…** - ì‚¬ìš©ì ì„¤ì • ë¬´ì‹œ ë¬¸ì œ
5. **message_count ì—…ë°ì´íŠ¸** - ë°ì´í„° ì •í•©ì„±
6. **ìºë¦­í„° ì •ë³´ ê²€ì¦** - ë°ì´í„° ë¬´ê²°ì„±

### ğŸŸ¢ Medium (ë°°í¬ í›„ ê°œì„  ê°€ëŠ¥)

7. **ì—ëŸ¬ í•¸ë“¤ë§ ê°œì„ ** - ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ
8. **í”„ë¡ íŠ¸ì—”ë“œ ì—ëŸ¬ ì²˜ë¦¬** - UX ê°œì„ 
9. **ë™ì‹œì„± ë¬¸ì œ** - ì—£ì§€ ì¼€ì´ìŠ¤
10. **ì„±ëŠ¥ ìµœì í™”** - í™•ì¥ì„±

---

## ğŸ”§ ìˆ˜ì • ì œì•ˆ

### 1. ì¸ì‚¬ë§ ì²˜ë¦¬ ê°œì„ 

```python
# chat.py:890-895 ìˆ˜ì •
if not existing_messages:
    _merge_character_tokens(chat_room.character, current_user)
    greeting = chat_room.character.greeting or f"ì•ˆë…•í•˜ì„¸ìš”! {chat_room.character.name}ì…ë‹ˆë‹¤."
    if greeting.strip():
        await chat_service.save_message(
            db, chat_room.id, "assistant", greeting
        )
        await db.commit()
```

### 2. CharacterSetting ëª¨ë¸ëª… ìˆ˜ì •

```python
# chat.py:1218-1227 ìˆ˜ì •
if not settings:
    # ì‚¬ìš©ìì˜ preferred_model ì‚¬ìš©, ì—†ìœ¼ë©´ ì‹œìŠ¤í…œ ê¸°ë³¸ê°’
    default_model = current_user.preferred_model or 'gemini'
    settings = CharacterSetting(
        character_id=character.id,
        ai_model=default_model,
        temperature=0.7,
        max_tokens=300
    )
```

### 3. AI API í‚¤ ê²€ì¦ ì¶”ê°€

```python
# ai_service.py:get_ai_chat_response ìˆ˜ì •
if preferred_model == 'gemini' and not settings.GEMINI_API_KEY:
    raise ValueError("Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
elif preferred_model == 'claude' and not settings.CLAUDE_API_KEY:
    raise ValueError("Claude API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
```

### 4. message_count ì—…ë°ì´íŠ¸

```python
# chat_service.py:save_message ìˆ˜ì •
async def save_message(...):
    chat_message = ChatMessage(...)
    db.add(chat_message)
    # message_count ì¦ê°€
    await db.execute(
        update(ChatRoom)
        .where(ChatRoom.id == chat_room_id)
        .values(
            message_count=ChatRoom.message_count + 1,
            updated_at=func.now()
        )
    )
    await db.commit()
```

---

## ğŸ“ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ì¸ì‚¬ë§ None ì²˜ë¦¬ ì¶”ê°€
- [ ] CharacterSetting ëª¨ë¸ëª… ìˆ˜ì •
- [ ] AI API í‚¤ ê²€ì¦ ì¶”ê°€
- [ ] message_count ì—…ë°ì´íŠ¸ ë¡œì§ ì¶”ê°€
- [ ] AI ì‘ë‹µ None ì²˜ë¦¬ ì¶”ê°€
- [ ] ìºë¦­í„° ì •ë³´ ê²€ì¦ ì¶”ê°€
- [ ] ì—ëŸ¬ í•¸ë“¤ë§ ê°œì„ 
- [ ] í”„ë¡ íŠ¸ì—”ë“œ ì—ëŸ¬ ë©”ì‹œì§€ ê°œì„ 
- [ ] ë™ì‹œì„± ë¬¸ì œ í•´ê²°
- [ ] ì„±ëŠ¥ ìµœì í™”

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2024ë…„ 8ì›”


