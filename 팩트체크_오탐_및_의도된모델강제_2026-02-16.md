# 팩트체크: 오탐 및 의도된 모델 강제 정리 (2026-02-16)

## 목적
- 2026-02-16 세션에서 나온 Codex 1차 분석 중 오탐을 정정한다.
- 운영 정책상 의도된 모델 강제(Claude 고정/폴백) 코드를 버그와 분리해 문서화한다.
- 이후 리뷰에서 동일한 오탐이 반복되지 않도록 기준을 남긴다.

## 최종 결론 요약
- 모델 강제(`preferred_model="claude"`) 경로 다수는 **의도된 운영 정책**으로 분류한다.
- 내가 제기했던 일부 리스크는 코드 기준으로 **오탐**이었다.
- 현재 운영 방식(운영 Postgres + 신규 변경은 `postgres_migration.py` 베스트에포트 + 로컬 Docker 재빌드) 기준에서, UUID 타입 통일은 **필수 작업이 아님**으로 정정한다.

---

## 1) 의도된 모델 강제 라우팅 (정책으로 확정)

### 1.1 Agent/Story 계열 Claude 고정 근거
- `backend-api/app/api/chat.py:2818`
  - `preferred_model="claude"`로 호출.
- `backend-api/app/api/chat.py:3141`
  - 주석에 정책 명시: `payload(model/sub_model) ... 무시`.
- `backend-api/app/api/chat.py:3145`
  - `preferred_model = "claude"` 고정.
- `backend-api/app/api/chat.py:8840`
  - 후처리 분기에서도 `preferred_model="claude"` 사용.

### 1.2 Storydive 계열 Claude 고정 근거
- `backend-api/app/api/storydive.py:499`
- `backend-api/app/api/storydive.py:958`
- `backend-api/app/api/storydive.py:1028`
- `backend-api/app/api/storydive.py:1094`
- `backend-api/app/api/storydive.py:1135`
  - 위 구간들에서 `preferred_model: "claude"` 또는 동등 고정값 사용.

### 1.3 OrigChat 계열 Claude 고정 근거
- `backend-api/app/services/origchat_service.py:334`
- `backend-api/app/services/origchat_service.py:446`
- `backend-api/app/services/origchat_service.py:656`
- `backend-api/app/services/origchat_service.py:840`
- `backend-api/app/services/origchat_service.py:902`
- `backend-api/app/services/origchat_service.py:1207`
  - `preferred_model="claude"` 반복 사용.

### 1.4 정책 해석
- 이 고정은 "모델 선택 기능 미구현"이 아니라, 안정성(특히 JSON 출력 안정성)과 폴백 목적의 운영 정책으로 해석한다.
- 따라서 향후 리뷰에서는 `하드코딩=버그`로 단정하지 않고, "의도된 강제 라우팅 정책" 여부를 먼저 확인한다.

---

## 2) 오탐 정정 목록 (코드 기준 재검증)

### 2.1 Pydantic `orm_mode` 미전환 추정은 오탐
- 근거:
  - `backend-api/app/schemas/character.py:402`
  - `backend-api/app/schemas/character.py:413`
  - `backend-api/app/schemas/character.py:431`
  - `backend-api/app/schemas/chat.py:71`
  - `backend-api/app/schemas/chat.py:85`
- 정정: `from_attributes` 전환이 이미 적용된 상태.

### 2.2 "채팅 메시지 전체삭제 API 없음"은 오탐
- 근거:
  - `backend-api/app/api/chat.py:9054`
  - `backend-api/app/services/chat_service.py:243`
  - `frontend/char-chat-frontend/src/lib/api.js:790`
  - `frontend/char-chat-frontend/src/lib/api.js:791`
- 정정: 백엔드 엔드포인트와 프론트 호출 모두 존재.

### 2.3 "read/unread API 없음"은 오탐
- 근거:
  - `backend-api/app/api/chat_read.py:21`
  - `backend-api/app/api/chat_read.py:121`
  - `frontend/char-chat-frontend/src/lib/api.js:771`
  - `frontend/char-chat-frontend/src/lib/api.js:772`
  - `frontend/char-chat-frontend/src/lib/api.js:774`
- 정정: 읽음/안읽음 관련 API 및 프론트 연동 존재.

### 2.4 "Celery 미구성"은 오탐
- 근거:
  - `backend-api/requirements.txt:21`
  - `backend-api/app/core/celery_app.py:5`
  - `backend-api/start_celery_worker.sh:5`
- 정정: Celery 의존성/앱/워커 스크립트가 이미 구성됨.

### 2.5 "에이전트 SSE 상태머신 미구현"은 오탐
- 근거:
  - `frontend/char-chat-frontend/src/pages/AgentPage.jsx:73`
  - `frontend/char-chat-frontend/src/pages/AgentPage.jsx:75`
  - `frontend/char-chat-frontend/src/pages/AgentPage.jsx:2057`
  - `frontend/char-chat-frontend/src/lib/generationAPI.js:22`
  - `backend-api/app/api/generation.py:103`
- 정정: 프론트 상태머신 + SSE 경로 존재.

### 2.6 "`app.schemas.point` 누락성 장애(현재 코드 기준)" 추정은 오탐
- 근거:
  - `backend-api/app/schemas/__init__.py:64`
  - `backend-api/app/schemas/__init__.py:73`
  - `backend-api/app/schemas/__init__.py:76`
- 정정: point 관련 스키마는 `payment` 모듈 export를 통해 노출됨.

---

## 3) 이슈가 아닌 항목으로 정리된 내용

### 3.1 UUID 타입 통일 작업
- 관찰:
  - `backend-api/app/models/chat_read_status.py:6` (`PG_UUID` 직접 사용)
  - `backend-api/app/models/character.py:9` (공용 `UUID` 타입 사용)
  - `backend-api/app/core/database.py:19` (공용 `UUID` TypeDecorator 정의)
- 정리:
  - 타입 혼용은 존재하지만, 현재 운영/배포 방식에서는 즉시 통일이 필수는 아님.
  - 신규 테이블/컬럼 추가 시 기존 운영 플로우(`postgres_migration.py` + 로컬 Docker 재빌드) 기준으로 처리 가능.

### 3.2 JWT 서명 불일치
- 근거:
  - `backend-api/app/core/config.py:48`
  - `backend-api/app/core/security.py:44`
  - `chat-server/src/config/config.js:22`
  - `chat-server/src/middleware/authMiddleware.js:25`
- 정리:
  - 코드상 공통 키(`JWT_SECRET_KEY`) 사용 구조는 존재.
  - 실제 장애 여부는 코드가 아니라 환경변수 불일치/배포 설정에 의해 결정됨.

---

## 4) 향후 리뷰 기준 (재오탐 방지)
- 모델 고정 코드를 발견해도 즉시 버그로 분류하지 않는다.
- 아래 순서로 확인 후 분류한다.
  1. 코드 주석/문서에 정책이 명시되어 있는가?
  2. 운영 안정성(JSON 안정성/폴백/기획상 제한) 사유가 있는가?
  3. 의도된 고정이면 "정책 경로"로 표기하고, 해제 조건만 기록한다.
- 환경 의존 이슈(JWT/DB 드라이버)는 "코드 버그"와 분리하여 문서화한다.

## 5) 변경 이력
- 2026-02-16: 초안 작성 (Codex), 사용자 피드백 반영
  - 모델 하드코딩 관련 분류를 `버그`에서 `의도된 정책`으로 정정
  - 기존 오탐 항목을 근거 라인과 함께 정리
