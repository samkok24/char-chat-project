# 개발일지 - 2025년 8월 4일

## 📋 프로젝트: AI 캐릭터 챗 프로젝트 v2

### 🎯 작업 목표
1. JWT 인증 오류 해결 및 서비스 간 통신 정상화
2. 채팅 관리 기능 구현 (삭제, 초기화)
3. AI 모델 선택 기능 구현
4. 캐릭터 메모리 시스템 개선 계획 수립
5. 웹소설 통합 기능 설계

---

## 🔧 기술적 구현 사항

### 1. JWT 토큰 인증 문제 해결
**문제점**
- chat-server 로그: `JWT 토큰 오류: invalid signature`
- backend-api와 chat-server 간 JWT_SECRET 불일치

**해결 방법**
```yaml
# docker-compose.dev.yml 수정
chat-server:
  env_file:
    - ./.env  # 환경변수 파일 통일
```

### 2. 채팅 삭제 기능 구현

#### 2.1 백엔드 API 추가
```python
# backend-api/app/api/chat.py
@router.delete("/rooms/{room_id}/messages")  # 대화 내용 초기화
@router.delete("/rooms/{room_id}")  # 채팅방 삭제

# backend-api/app/services/chat_service.py
async def delete_all_messages_in_room()
async def delete_chat_room()
```

#### 2.2 프론트엔드 구현
- ChatPage.jsx: 드롭다운 메뉴에 "대화 내용 초기화" 옵션 추가
- RecentCharactersList.jsx: 각 캐릭터 카드에 삭제 버튼 추가
- 이벤트 버블링 방지: `e.stopPropagation()`

### 3. 대화내역 페이지 구현

#### 3.1 새 페이지 생성
- `ChatHistoryPage.jsx`: 무한 스크롤 구현
- IntersectionObserver API 활용
- 페이지네이션: 20개씩 로드

#### 3.2 라우팅 추가
```javascript
// App.jsx
<Route path="/history" element={<ProtectedRoute><ChatHistoryPage /></ProtectedRoute>} />
```

### 4. 캐릭터 채팅 카운트 시스템

#### 4.1 데이터베이스
- Character 모델: `chat_count` 필드 (이미 존재)

#### 4.2 백엔드 구현
```python
# character_service.py
async def increment_character_chat_count(db, character_id):
    # 트랜잭션 원자성 보장을 위해 commit은 호출자에서 처리
```

#### 4.3 UI 업데이트
- CharacterCard.jsx: 말풍선 뱃지 제거, 텍스트로 표시

### 5. AI 모델 선택 기능

#### 5.1 데이터베이스 스키마 변경
```sql
ALTER TABLE users ADD COLUMN preferred_model VARCHAR(50) DEFAULT 'gemini';
ALTER TABLE users ADD COLUMN preferred_sub_model VARCHAR(50) DEFAULT 'gemini-2.5-pro';
```

#### 5.2 API 엔드포인트
```python
# users.py
GET /users/me/model-settings  # 모델 설정 조회
PUT /users/me/model-settings  # 모델 설정 업데이트
```

#### 5.3 AI 서비스 동적 모델 선택
```python
# ai_service.py
async def get_ai_chat_response(
    character_prompt, 
    user_message, 
    history,
    preferred_model='gemini',
    preferred_sub_model='gemini-2.5-pro'
)
```

#### 5.4 모델 매핑
- Gemini 2.5 Pro → gemini-1.5-pro (실제 API)
- GPT 4.1 → gpt-4o (실제 API)
- ARGO → 커스텀 모델 (향후 구현)

### 6. 프론트엔드 모델 선택 모달
- `ModelSelectionModal.jsx` 구현
- Collapsible 섹션으로 모델 그룹화
- 현재 선택 모델 상단 표시
- API 연동으로 설정 저장

---

## 🏗️ 아키텍처 개선 사항

### 1. 서비스 간 통신
- Docker 네트워크 내부: 서비스명 사용
- 브라우저 → 백엔드: localhost 사용
- 환경변수 통일로 설정 관리 개선

### 2. 트랜잭션 관리
- 서비스 레이어: commit 제외
- API 레이어: 트랜잭션 완료 책임

### 3. 이벤트 처리
- Socket.IO: AI 타이핑 인디케이터 구현
- React: useEffect 의존성 최적화

---

## 📊 성능 최적화

### 1. 무한 스크롤
- IntersectionObserver로 효율적 구현
- 20개 단위 페이지네이션

### 2. 코드 스플리팅
- React.lazy로 ChatHistoryPage 동적 로드

---

## 🔮 향후 계획

### 1. 캐릭터 메모리 시스템 개선
**무료 버전**
- 모든 캐릭터 정보 프롬프트에 포함
- 최근 10개 메시지만 컨텍스트로 사용

**프리미엄 버전**
- Phase 1: 세션 저장, 긴 히스토리 (1주)
- Phase 2: 벡터 DB 통합 (2-3주)
  - Pinecone/Weaviate/Chroma 검토
  - 무한 기억, 관계 추적
  - 지능형 컨텍스트 검색

### 2. 웹소설 통합 ("텍스트 챗")
**Story Importer 강화**
- 텍스트 제한: 50,000 → 500,000자
- 파일 업로드: .txt, .hwp, .hwpx, .docx, .doc
- 에피소드 파싱: 정규식으로 자동 분리
- FileParser 클래스 구현 예정

**파일 처리 라이브러리**
- python-docx: Word 문서
- olefile, pyhwp: 한글 문서
- chardet: 텍스트 인코딩 감지

### 3. 비즈니스 모델
**무료 vs 프리미엄 차별화**
| 기능 | 무료 | 프리미엄 |
|------|------|----------|
| 대화 기억 | 10개 | 무제한 |
| 세션 유지 | 현재만 | 영구 |
| 관계 발전 | ❌ | ✅ |
| 특별 기억 | ❌ | 자동 추출 |
| 운영 비용 | $0 | $0.1-0.5/user |

---

## 🐛 해결된 이슈
1. JWT 토큰 시그니처 불일치
2. 프론트엔드 무한 리로드 (useEffect 의존성)
3. 500 Internal Server Error (API 키 문제)
4. AI 응답 없음 (모델 설정 오류)
5. 이벤트 버블링 (stopPropagation)

---

## 📝 코드 변경 사항
- 총 변경 파일: 약 20개
- 새로 생성된 파일: 5개
  - ChatHistoryPage.jsx
  - ModelSelectionModal.jsx
  - add_model_columns.sql (임시, 삭제됨)
  - update_default_model.sql (임시, 삭제됨)
  - file_parser.py (예정)

---

## 💡 기술 스택
- Backend: FastAPI, SQLAlchemy, Pydantic
- Frontend: React, Vite, TailwindCSS, shadcn/ui
- Database: SQLite, Redis
- AI: Gemini, Claude, OpenAI APIs
- Container: Docker, Docker Compose
- Real-time: Socket.IO

---

## 📌 메모
- 벡터 DB는 프리미엄 차별화의 핵심
- 파일 업로드는 BackgroundTasks로 비동기 처리 필요
- 에피소드 기반 대화는 컨텍스트 관리가 핵심
- ARGO 모델은 향후 자체 파인튜닝 모델로 대체 예정