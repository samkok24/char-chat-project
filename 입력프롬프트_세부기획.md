# 입력프롬프트 세부 기획 (라이트 유저 지향)

본 문서는 현재 코드 구조(세션 격리/버전 게이팅/SSE 스트리밍/게스트·로그인 저장 방식)와 **모순 없이** 동작하는 입력 프롬프트 UX를 설계한다.

## 1. 목표
- 라이트 유저가 **입력 최소화**로 **빠른 보상(3초 이내 초미리보기)** 을 얻는다
- 고급 유저는 **수동(QTE) 모드**에서 상호작용형 집필 경험을 사용한다
- 자동/수동은 **세션 단위**로 완전히 분리, 전환 시 상태 충돌/누수 없음

## 2. 상태 모델(프론트 전용)
- INITIAL: 대기 상태(입력창/템플릿/빠른 실행)
- GENERATING_AUTO: 자동 생성(SSE)
- GENERATING_MANUAL_INIT: 수동 200자 1회 생성(HTTP)
- AWAITING_MANUAL_INPUT: QTE 대기/루프(HTTP)

현 코드 일치: 자동=기존 `storiesAPI.generateStoryStream` 사용, 수동= `chatAPI.agentSimulate` 200자 루프.

## 3. 공통 가이드
- 세션 격리 유지: 세션별 상태 컨테이너(`genBySessionRef`, `sessionLocalMessagesRef` 등)를 그대로 사용
- 버전 게이팅 유지: 생성 시작 시 세션 버전 +1, 콜백/응답은 버전 일치 시만 반영
- 중단=네트워크 abort: 현재 세션 컨트롤러만 abort, 서버 작업은 백그라운드로 지속(자동에 한함)

## 4. 자동 생성(라이트 모드)
### 4.1 입력 방식
- 템플릿 카드(6~9개): “회사 퇴근길 힐링 이야기”, “학교에서 생긴 기묘한 일” 등
- 카테고리 1클릭: “로맨스/판타지/스릴러”
- 길이 토글: “짧게/보통/길게”
- 자유 입력창(선택)

### 4.2 동작
1) 클릭 즉시 초미리보기(두 문장) 목표로 프롬프트 구성 → `storiesAPI.generateStoryStream` 호출
2) SSE 이벤트 사용(meta/preview/episode/final)
   - preview 수신 즉시 사용자에게 노출(최대 500자)
   - episode로 본문 계속 스트리밍
3) 중단: 현재 세션 컨트롤러 abort → 상태 STOPPED, 백엔드는 헤드리스 진행(완료 시 해당 세션에 반영)

### 4.3 저장/활용
- 로그인: 완료 시 로컬 보관함에 임시 저장(현재 구조 유지)
- 게스트: 세션 메모리 보관(최근 3개 표시까지)
- 툴바: 복사/다운로드/공유/이어쓰기(다음 800자)

## 5. 수동 생성(QTE 모드, 고급)
### 5.1 입력 UI
- 액션 버튼(3개): 가다/싸우다/대화하다
- 이모지(3개): 기쁨/분노/슬픔
- 타이머: 2초, **첫 클릭 시 시작**, 링 애니메이션
- 커맨드 트레이: 선택 조합이 아이콘으로 누적 표시

### 5.2 동작
1) GENERATING_MANUAL_INIT: 
   - 프롬프트(템플릿/자유 입력)를 바탕으로 **200자**만 생성
   - API: `chatAPI.agentSimulate({ content: "(200자만)" + 사용자 프롬프트 })`
2) AWAITING_MANUAL_INPUT 루프:
   - 타이머가 끝나면 선택 조합을 지시문으로 변환(예: ACTION_WALK+EMOJI_SAD → “슬픈 기분으로 걸어간다”) 
   - API: `chatAPI.agentSimulate({ content: 지시문, history: 이전 본문 누계 })` → **200자** 덧붙여 반환
   - 누적은 동일 세션의 동일 assistant 말풍선 `fullContent`에 append

### 5.3 상태/세션 안전장치(현 코드에 부합)
- 세션 버전 체크: 응답이 도착해도 **현재 세션 버전**과 다르면 무시
- 메시지 타겟 고정: 초기 `assistantThinkingId`에만 업데이트, 누락 시 **새 메시지 생성 금지**
- 세션 전환 시 화면 반영: `activeSessionIdRef` 기준으로 대상 세션과 일치할 때만 렌더링

## 6. 프롬프트 조합 규칙(라이트)
- 템플릿 클릭 시 내부 룰:
  - 장르 키워드 1, 배경 1, 톤 1, 인물 1을 기본으로 합성
  - 길이 토글에 따라 “짧게/보통/길게” 지시 추가
- 수동 모드 지시문 변환 테이블(예시):
  - ACTION_WALK → “어딘가로 걸어간다”
  - ACTION_FIGHT → “격렬한 전투에 돌입한다”
  - ACTION_TALK → “상대와 진지하게 대화한다”
  - EMOJI_HAPPY → “기쁜 감정으로”
  - EMOJI_ANGRY → “분노를 느끼며”
  - EMOJI_SAD → “슬픈 기분으로”
  - 조합: 감정(선택) + 액션 1개 → “감정 수식 + 액션 문구”

## 7. 접근성/모바일
- 버튼 탭 영역 확대(44px 이상), 키보드 포커스 이동 지원
- 타이머는 텍스트 안내 병행(“2초 내 선택 완료”)

## 8. 지표/실험
- TTFP(첫 문장까지 시간), 템플릿 클릭률, 수동 진입률, 루프당 클릭 수, 저장/공유율
- A/B: 템플릿 6 vs 9, 초미리보기 2문장 vs 4문장, 타이머 1.5s vs 2.0s

## 9. 기술 정합성(현 코드 기준)
- 자동(SSE): `storiesAPI.generateStoryStream` 그대로 사용
- 수동(HTTP): `chatAPI.agentSimulate` 반복 호출(200자 지시 포함)
- 세션 격리/버전 게이팅/헤드리스 감시/게스트 저장: **이미 구현된 패턴** 재사용
- 서버 신규 API 없이도 MVP 구현 가능(필요 시 추후 전용 엔드포인트로 교체)

## 10. 안정 적용 계획(세션 이슈 재발 방지)

### 10.1 변경 금지 핵심(세션 안정망)
- 세션별 컨테이너: `genBySessionRef`, `jobToSessionRef`, `sessionLocalMessagesRef`
- 세션 버전 게이팅: `sessionVersionRef` 로직(생성 시작 시 +1, 불일치 콜백 무시)
- 화면 반영 기준: `activeSessionIdRef` 기반 렌더 반영
- 백그라운드 수거: `startHeadlessWatcher`(jobId가 있을 때만 실행, 세션별 1개)

위 4가지는 “읽기만” 하고 수정/삭제/대체하지 않는다.

### 10.2 기능 플래그(Feature Flag)
- 노출 제어: `localStorage('prompt:v2') === '1'` 또는 쿼리 `?promptV2=1`
- 플래그 OFF: 기존 UI 100% 유지(즉시 롤백 가능)

### 10.3 구성요소 격리
- `PromptBar`(라이트/자동), `ManualComposer`(수동/QTE)를 별도 컴포넌트로 분리
- 상위(`AgentPage`)에는 세션ID와 콜백만 전달(내부 상태는 컴포넌트에 캡슐화)

### 10.4 콜백 패턴 고정(세션/버전/메시지ID)
- 시작 시점에 `sid`와 `version` 캡처 → 모든 콜백은 “버전 일치”시에만 적용
- 메시지 타겟 고정: 초기 `assistantThinkingId`에만 업데이트
- 안전장치: 대상 메시지 미존재 시 새 어시스턴트 메시지 생성 금지(초기 thinking 1회만)

### 10.5 통신 정책
- 자동: 기존 SSE(`storiesAPI.generateStoryStream`)만 사용
- 수동: 비스트리밍(`chatAPI.agentSimulate`) 200자 루프만 사용
- 중단: 자동만 `controller.abort()` → STOPPED 처리, 서버 작업은 백그라운드로 지속

### 10.6 관측/로그(권장)
- `analytics` 이벤트로 `sid`, `version`, `event(meta/preview/episode/final/error)`, 지연(ms) 기록
- 세션 전환/중단/완료 타이밍 로깅으로 회귀 시 신속 추적

### 10.7 단계적 적용(롤아웃)
1) 플래그/토글만 추가(경계선 마련)
2) 라이트 모드(템플릿·1클릭·길이 토글) → 기존 SSE 호출만 사용
3) 수동 모드(200자 루프) → `ManualComposer` 내부에서만 처리
4) QTE(버튼 3 + 이모지 3, 타이머 2초) → 조합→지시문 변환 후 200자 이어쓰기
5) A/B 및 지표 검증 후 버튼 세트/타이머/템플릿 확대

### 10.8 회귀 테스트 매트릭스(필수)
- 동시 생성/세션 전환: A(자동)↔B(자동), A(자동)↔B(수동) 왕복 전환, 각 세션에 결과 1개 고정
- 네트워크/중단: 자동 중단 시 STOPPED, 헤드리스 완료 수거 정상 / 수동 루프 전환 시 원 세션만 업데이트
- 로그인/게스트: 저장소 분리(`localStorage` vs `sessionLocalMessagesRef`) 유지
- 프리뷰 일관성: 프리뷰가 켜진 세션에만 표시, 타 세션으로 복제 금지

### 10.9 롤백/안전장치
- 플래그 OFF 시 즉시 과거 UI 복귀
- 새 컴포넌트 제거 없이 상위에서 미노출 처리
- 예외 시 기본 버튼 → 기존 SSE 호출로 우회

### 10.10 리스크가 낮은 이유
- “누가·언제·어디에”를 세션ID/버전/메시지ID로 고정, 불일치 업데이트는 전부 무시
- 새 입력프롬프트는 기존 스트리밍·세션 로직을 **호출만** 하므로 안정망을 훼손하지 않음

## 11. 개발 우선순위(안전 우선 로드맵)

### Phase 0: 안정망 고정(코드 보호)
- 변경 금지: `genBySessionRef`, `jobToSessionRef`, `sessionLocalMessagesRef`, `sessionVersionRef`, `startHeadlessWatcher`, `activeSessionIdRef` 기반 렌더
- 기준: 세션 전환/동시 생성/중단/게스트·로그인 시나리오 회귀 테스트 100% 통과

### Phase 1: 라이트 자동 모드(MVP, 플래그 ON 전용)
- 내용: 템플릿(6), 카테고리(3), 길이 토글(3) + 기존 SSE 호출(meta/preview/episode/final)
- 성공 기준(게이트):
  - 첫 프리뷰(TTFP) ≤ 3초, 중복 말풍선 0, 세션 덮어쓰기 0
  - 모바일(375px)에서 버튼 탭/스크롤 자연스러움 확인
- 롤백: 플래그 OFF 시 즉시 과거 UI로 복귀

### Phase 2: 라이트 개선(보상/활용 강화)
- 내용: 초미리보기(두 문장) 시각 강조, 저장/공유 단축 버튼, 제목 자동추천 3개
- 성공 기준: 저장률/공유 클릭률 상승(A/B), 이탈률 악화 없음
- 리스크: UI 과부하 → 버튼 최소 유지

### Phase 3: 수동 모드(200자 루프, 베타)
- 내용: `chatAPI.agentSimulate` 200자 단위 비스트리밍, 동일 assistant 말풍선에 누적
- 제약: SSE 미사용(중간 정지/전환 안전), 버전 게이팅/세션 캡처 적용
- 성공 기준: 루프 3회까지 중복/덮어쓰기 0, 응답시간 허용 범위(≤ 2.5s/호출)

### Phase 4: QTE 최소(고급 탭)
- 내용: 액션 3 + 이모지 3, 타이머 2초, 조합→지시문 변환 테이블 적용
- 성공 기준: 사용성(초심자 완주율 저하 없음), 버전/세션 이슈 0
- A/B: 타이머 1.5s vs 2.0s, 버튼 세트 3 vs 5

### Phase 5: 확장/개인화(선택)
- 동적 추천 버튼(문맥 기반), 사용자 프리셋, 이어쓰기(+800자) 최적화
- 비용/지연 모니터링과 병행하여 점진 배포

### 공통 게이트(각 Phase 종료 시 필수 체킹)
- 회귀 테스트 매트릭스 전부 통과(세션 전환/동시 생성/중단/게스트·로그인/프리뷰 일관성)
- 에러/중복 로그 0(analytics 기준), 롤백 경로 정상 작동 확인


