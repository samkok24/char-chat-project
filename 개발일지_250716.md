## 2025-07-16 (수) 개발일지
* 7-14 개발일지 이후 변경·해결 사항을 기준으로 정리*

### 1. 목표 / 배경
1) 백엔드 FastAPI 서버 재가동 및 신규 API 추가
2) 프론트엔드 `ProfilePage` 확장 및 오류 수정
3) AI 모델 선택(Claude 포함) 지원
4) Docker 개발환경 안정화
5) **(핵심)** 스토리 임포터 기능의 연쇄적 오류 해결 및 UX 개선

---

### 2. 주요 진행내역

#### 2-1. 백엔드
1. **`UserProfileResponse` 스키마 추가**
   • `character_count`, `total_chat_count`, `total_like_count` 필드 확장
   • `is_active`, `is_verified`, `updated_at` 필드 누락으로 500 에러 → 즉시 보강

2. **`user_service.get_user_profile` 구현**
   • 다중 Aggregation(캐릭터·채팅·좋아요 수) 쿼리 작성
   • 반환 타입을 새 스키마로 통일

3. **`/users/{id}` API 라우터 작성 & `main.py` 재등록**
   • prefix 없이 루트에 포함해 RESTful 친화적 URL 확보

4. **AI 모델 추상화 (`ai_service.py`)**
   • `AIModel = Literal["gemini","claude","openai"]`
   • `get_claude_completion`, `get_ai_completion` 통합 함수 구현
   • `story_service.py` → `ai_model` 파라미터로 분기

5. **스토리 임포터 관련 오류 디버깅**
   • `NameError: name 'AIModel' is not defined` → `story_service.py`에 import 추가
   • `AttributeError: 'str' object has no attribute 'content'` → `analyze_story_from_text` 호출 시 request.content 전달 수정
   • `TypeError: unexpected keyword argument 'max_output_tokens'` → Gemini API 호출 시 인자 위치 조정
   • `400 API key not valid` → `.env` 파일에 실제 Gemini 키 설정 및 컨테이너 재시작
   • `429 You exceeded your current quota` → 일시적으로 Claude 모델로 전환
   • `AttributeError: 'AsyncAnthropic' object has no attribute 'messages'` → `requirements.txt`의 anthropic 버전 0.7.8 → 0.29.0 상향

#### 2-2. 프론트엔드
1. **`usersAPI.getUserProfile` 추가 (`lib/api.js`)**
2. **`ProfilePage.jsx` 리팩터링**
   • 통계(캐릭터·챗·좋아요·루비) 표시
   • 본인 페이지일 때만 “프로필 수정” 버튼 노출
3. **컴파일 오류 대응**
   • `Calendar` 이중 import 삭제
   • `usersAPI` export 누락 보강
4. **캐릭터 생성 폼 UX 개선**
   • 클라이언트 측 필수값 검증 + 에러 토스트 표시
5. **스토리 임포터 모달 병합 및 UX 강화**
   • 기존 `StoryImporterPage.jsx`를 `StoryImporterModal.jsx`로 재구성 (모달 팝업 형태로 변환)
   • `CreateCharacterPage.jsx`에 AI 추천 섹션 추가: 눈에 띄는 UI (헤드라인, 설명, 버튼)로 사용자 유치
   • `AnalyzedCharacterCard.jsx` 버튼 동적화: `buttonText`/`buttonIcon` prop 추가로 "이 캐릭터로 채우기" 등 커스터마이징
   • 데이터 적용 로직: 모달에서 선택 시 캐릭터 생성 폼 자동 채우기 (`handleApplyImportedData` 구현)
   • 모달 UI: 분석 입력 영역, 결과 표시 (세계관, 플롯, 캐릭터 카드), "다시 분석하기" 버튼 추가
6. **스토리 임포터 관련 오류 디버깅**
   • `AxiosError: timeout of 10000ms exceeded` → `api.js`의 axios timeout을 60000ms(60초)로 증가
   • `TypeError: Cannot read properties of undefined (reading 'map')` → `CreateCharacterPage.jsx`의 useEffect에서 prefilledData 키 동적 매핑으로 안전 업데이트

#### 2-3. Docker / CI 환경
1. `docker-compose.dev.yml` 경고(`version` 키) 분석 – 기능 영향 無
2. **컨테이너 재빌드 플로우 정착**
   • 코드 변경 시 `down -v && up --build` 권장
3. **Docker Desktop 스캔 무한 새로고침 이슈** 안내
   • Docker Scout 자동 스캔 작업임을 확인, 필요 시 비활성화 방법 문서화

#### 2-4. 스토리 임포터 기능 디버깅 및 UX 개선 여정
1.  **연쇄적인 백엔드 오류 해결**
    *   **1단계 (`NameError`):** `story_service.py`에서 `AIModel` import 누락 → import 구문 추가.
    *   **2단계 (`AttributeError`):** `story_importer.py`에서 `analyze_story_from_text` 호출 시 `request` 객체 자체를 전달 → 숨겨진 Traceback을 `logging.exception`으로 확인 후 `request.content`로 수정.
    *   **3단계 (`TypeError`):** Gemini API 호출 시 `max_output_tokens` 인자를 잘못된 위치에 전달 → `GenerationConfig` 객체 내부로 이동.
    *   **4단계 (`400 API key not valid`):** `.env` 파일에 예시 키(`your-gemini-api-key-here`)가 설정된 것을 `docker exec`로 확인 → 실제 API 키로 교체 후 재시작.
    *   **5단계 (`429 Quota Exceeded`):** Gemini 무료 등급 사용량 초과 → 임시 해결책으로 AI 모델을 `claude`로 변경.
    *   **6단계 (`AttributeError: 'AsyncAnthropic' object has no attribute 'messages'`):** 코드와 라이브러리 버전 불일치 → `requirements.txt`의 `anthropic` 버전을 `0.7.8`에서 `0.29.0`으로 상향 후 재빌드.
2.  **연이은 프론트엔드 오류 해결**
    *   **타임아웃 (`AxiosError`):** AI 분석에 10초 이상 소요 → `api.js`의 `axios` 타임아웃을 `60000`(60초)으로 증가.
    *   **데이터 구조 불일치 (`TypeError`):** `prefilledData`와 `formData` 구조 차이로 `.map` 오류 발생 → `CreateCharacterPage.jsx`의 `useEffect` 로직을 수정하여 안전하게 데이터 매핑.
3.  **점진적인 UX 개선**
    *   **1차 개선:** "분석 → 페이지 이동 → 생성" 흐름을 개선하기 위해, `AnalyzedCharacterCard.jsx`를 단순 정보 표시에서 **편집 가능한 폼 컴포넌트**로 변경하고, `StoryImporterPage.jsx`에 저장 로직 구현.
    *   **2차 개선 (최종):** 더 나은 UX를 위해 **스토리 임포터 기능을 `CreateCharacterPage.jsx`에 모달로 병합**.
        *   **기능 발견성:** 생성 페이지에 눈에 띄는 AI 추천 섹션 추가.
        *   **컴포넌트 재사용:** `StoryImporterPage.jsx`를 `StoryImporterModal.jsx`로 재구성.
        *   **데이터 흐름 변경:** 모달에서 '저장' 대신 '적용' 개념으로 변경, 선택한 캐릭터 정보를 생성 폼에 자동으로 채움.

---

### 3. 해결된 주요 이슈

| 날짜 | 이슈 | 원인 | 해결 |
|------|------|------|------|
| 7-14 | `ModuleNotFoundError: app.schemas.point` | 컨테이너가 오래된 이미지 사용 | 전체 이미지 **재빌드** |
| 7-14 | `NameError: Character not defined` | 라우터 import 순환·미정의 | `characters.py` 타입 힌트 수정 |
| 7-15 | `/users/{id}` 500 | 스키마 필드 누락 | `UserProfileResponse` 필드 보강 |
| 7-15 | Vite Duplicate import | `Calendar` 중복 import | 중복 라인 제거 |
| 7-16 | Gemini 키 오류 | 잘못된 `.env` 값 | 키 재발급 & ENV 검증 로직 추가 |
| 7-16 | Docker Desktop 새로고침 지속 | 자동 이미지 스캔 | 설정→Docker Scout 비활성 안내 |
| 7-16 | 스토리 임포터 UX 불편 (페이지 이동 필요) | 별도 페이지 형태 | 모달 병합으로 즉시 사용 가능하게 개선 |
| 7-16 | 캐릭터 카드 버튼 고정 | 맥락별 버튼 텍스트 고정 | prop 동적화로 유연성 확보 |
| 7-16 | 백엔드 500 서버 오류 (NameError, AttributeError 등) | import 누락, API 호출 인자 오류, 키 무효 등 | 단계적 디버깅 (import 추가, 인자 위치 수정, .env 업데이트)
| 7-16 | 프론트 Axios 타임아웃 및 TypeError | API 지연 및 데이터 구조 불일치 | Timeout 증가, useEffect에서 안전 매핑

---

### 4. 성과
1. **유저 프로필 API 완성** – 프론트 통계 화면 정상 표시
2. **Claude 모델 지원** – 스토리 분석·생성에 Gemini/Claude/Azure OpenAI 선택 가능
3. **개발용 Docker 환경 안정화** – *“재빌드 후 즉시 반영”* 절차 확립
4. **프론트 UI/UX 보강** – 오류 없는 빌드, 입력 검증 및 피드백 향상
5. **스토리 임포터 통합** – 캐릭터 생성 프로세스에 모달로 병합, 사용자 유치 UI 추가로 기능 활용도 향상
6. **전체 시스템 안정화** – 다중 오류 해결로 백/프론트 연동 원활

---

### 5. 다음 할 일
1. 스토리 분석 엔드포인트(`ai_model` 파라미터) 수정 완료 → 프론트 연동
2. PostgreSQL 전환 대비: 마이그레이션 스크립트 재검토
3. 테스트 코드(Pytest, Vitest) 커버리지 70 % 이상 달성
4. 결제·포인트 모듈 MVP 설계 확정
5. 스토리 임포터 모달 모바일 최적화 및 입력 범위 검증 추가
6. alert() 대신 토스트 알림 라이브러리 도입

---

### 6. 회고 / 피드백
* 7-14에 발생했던 **“컨테이너 캐시로 인한 과거 코드 실행”** 문제를 통해, **CI 단계에서 이미지 태그를 커밋 SHA 기반으로 강제**하는 방안을 검토해야 함.
* 스키마·모델 변경 시 **Pydantic V2 키워드 변경(orm_mode→from_attributes)** 을 지속적으로 체크 리스트에 추가.
* 프론트/백 PR 템플릿에 **“Docker 재빌드 필요 여부”** 항목 추가 제안.
* 스토리 임포터 병합으로 UX가 크게 개선되었으나, 모바일 테스트를 통해 추가 세밀 조정 필요.
* 다중 디버깅 과정에서 단계적 오류 해결 (로그 출력, 도구 활용)이 효과적이었음. 앞으로도 logging 강화.

> “Chat First, Story Later” 철학 아래, 기능을 빠르게 붙여가면서도 안정성·재현성을 확보하는 데 집중한 한 주였다. 🎯 