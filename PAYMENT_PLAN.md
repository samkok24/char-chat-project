## 결제/이용 플랜 (턴 제한 기반) — 배포 전 점검용

작성일: 2026-02-06  
대상: 운영/투자자 데모용(비용 폭주 방지 우선)

---

## 1) 목적과 전제

### 목적
- **유저가 규칙을 한 번에 이해**하게 만들기(무료 → 대기 리필 → 크레딧 → 구독)
- **원가를 통제**하면서도 “상위 모델” 니즈를 흡수하기
- 서버에서 강제 가능한 형태로 설계(프론트만으로는 절대 보장 불가)

### 전제(SSOT)
- **턴(turn)**: “유저가 메시지를 1회 전송”했을 때 소비되는 기본 단위
- 내부 결제 통화: 프론트에서는 “루비”, 백엔드에서는 “포인트(UserPoint)”로 동작(동일 개념)
- 경쟁 서비스처럼 **모델별 비용 차등**이 필요할 수 있음 → “턴 배수(모델별 turn_cost)”로 대응

---

## 2) 용어 정의

- **무료턴 잔고(free_turn_balance)**: 일일 지급 + 대기 리필로 채워지는 “무료로 쓸 수 있는 턴”
- **대기 리필(wait refill)**: 일정 시간마다 무료턴을 추가 지급(플랜별 속도 차등)
- **루비(포인트) 잔고(ruby_balance)**: 충전/구매로 늘어나며, 무료턴이 부족할 때 사용
- **구독(subscriber)**: 상위 모델 접근, 대기 리필 강화, 크레딧(루비) 혜택 등 제공

---

## 3) 플랜 요약(정책 초안)

### 플랜별 핵심 규칙

| 구분 | 무료 플랜 | 구독 플랜 |
|---|---:|---:|
| 일일 기본 지급 | 10턴 | 10턴 |
| 대기 리필 | 3시간마다 +5턴 | 1시간마다 +10턴 |
| 무료턴 최대 보유(가드레일) | 권장: 30턴(조정 가능) | 권장: 120턴(조정 가능) |
| 상위 모델 사용 | 원칙적으로 제한(또는 비용 가중) | 사용 가능(단, 공정 사용 정책 적용) |
| 루비(포인트) 패키지 혜택 | 기본 | **15% 할인(권장 구현: 동일 가격 + 15% 보너스 루비)** |

> 중요: “대기 리필”을 넣을 때는 **무료턴 최대 보유(cap)** 이 사실상 필수 가드레일입니다.  
> cap이 없으면 “시간만 지나면 무한 적립” 인상 + 정책/원가 통제가 어려워집니다.

---

## 4) 무료턴 지급/리필 규칙(서버 기준)

### 4-1. 일일 기본 지급(하루 10턴)
- 기준 시각: **KST 00:00(권장)**  
- 정책(권장): “리셋”이 아니라 **최소 보장**
  - 매일 00:00에 `free_turn_balance = max(free_turn_balance, daily_grant)`
  - 이미 무료턴을 많이 남긴 유저의 잔고를 강제로 깎지 않음(UX/CS 리스크 방지)

### 4-2. 대기 리필(무료/구독)
- 무료: 3시간마다 +5
- 구독: 1시간마다 +10
- 리필은 “요청 시점 계산 방식”(cron 불필요) 권장
  - 마지막 리필 기준 시각(`last_refill_at`)과 현재 시각을 비교하여 경과한 구간 수만큼 지급
  - 지급 후에는 `free_turn_balance`를 cap까지 클램프
  - `last_refill_at`는 “현재시각”이 아니라 “적용된 구간만큼만 전진”시켜 잔여 시간을 보존

### 4-3. 무료턴 최대 보유(cap)
- 무료: 권장 30 (예: 10 + 5×4)
- 구독: 권장 120 (예: 10 + 10×11)

> cap은 “누적 방지”용입니다. 활성 유저는 써가면서 계속 리필을 받을 수 있으므로,  
> 원가/남용 방지 목적이라면 **추가 가드레일(공정 사용 정책/레이트리밋/상위모델 정책)** 도 같이 필요합니다.

---

## 5) 모델별 비용(경쟁 서비스식 세분화) — 권장안

### 5-1. 기본 원칙
- 각 모델은 “1메시지 = 몇 턴”인지 `turn_cost`를 가짐
- 차감은 **무료턴 → 루비(포인트)** 순서로 진행(아래 6절)

### 5-2. 정책 예시(수치는 확정 필요)
| 모델 등급 | free 플랜 사용 | subscriber 사용 | turn_cost 예시 |
|---|---|---|---:|
| 기본 | 가능 | 가능 | 1 |
| 중급 | (선택) 루비로만 | 가능 | 2 |
| 상위 | 불가(또는 루비로만) | “마음껏” 마케팅 가능(공정 사용 정책 포함) | 3~4 |

> “구독자는 상위모델 마음껏”을 유지하려면, 기술적으로는 아래 중 하나를 반드시 포함하는 걸 권장합니다.  
> - (A) 상위 모델도 turn_cost를 높게 잡고, 구독 무료턴으로도 소화되게 함(가장 단순)  
> - (B) 상위 모델은 별도 소프트 리밋/공정 사용 정책(비정상 사용만 제한)  
> 운영/데모 안정성 기준으로는 (A)+(B) 동시 적용이 가장 안전합니다.

---

## 6) 차감 우선순위(서버 강제)

### 6-1. 권장 우선순위
1) `free_turn_balance`에서 `turn_cost`만큼 차감  
2) 부족하면 `ruby_balance(UserPoint.balance)`에서 부족분 차감  
3) 둘 다 부족하면 “결제/충전 유도” 에러 반환

### 6-2. 환불/실패 처리(필수)
- 모델 호출 실패/타임아웃/서버 오류 등으로 응답을 제공하지 못한 경우:
  - **차감한 무료턴/루비를 즉시 복구(또는 트랜잭션 단위로 보정)** 해야 CS 리스크가 줄어듦
  - 최소한 “차감 여부”와 “실패 원인”은 로그로 남겨 사후 정산 가능해야 함

---

## 7) 구독 혜택(정책/구현 관점)

### 7-1. “크레딧 15% 할인” 구현 권장
- 결제 금액(가격)을 내리기보다, **동일 가격에 15% 보너스 루비 지급**을 권장
  - 사유: 가격 차등은 상품/세금/스토어/관리 복잡도가 올라감
  - 현 DB 스키마에 `bonus_point`가 이미 존재(가장 구현 리스크가 낮음)

### 7-2. 상위 모델 “마음껏” 표현을 위한 공정 사용 정책(FUP)
- 문구는 “무제한”로 하되, 운영 안정성을 위해 아래는 명시/내부 적용 권장
  - 자동화/봇 사용 탐지 시 제한
  - 짧은 시간 내 과도한 호출(예: 초당/분당 제한)
  - 비정상 패턴(다계정/프록시/스크립트)의 제한

---

## 8) 운영 안전장치(데모/운영에서 실패하지 않기)

### 8-1. 레이트 리밋(권장)
- 유저 단위: 분당 메시지 전송 제한
- IP 단위: 로그인/결제/대량 요청 제한

### 8-2. 관측(로그/지표) — 반드시 남길 것
- 메시지 요청마다:
  - user_id, model, turn_cost
  - 차감 전/후 free_turn_balance, ruby_balance
  - 실패/환불 여부 + 원인

### 8-3. 기능 플래그(롤백 대비)
- `TURN_BILLING_ENABLED` (턴 과금 강제 on/off)
- `WAIT_REFILL_ENABLED` (대기 리필 on/off)
- `SUBSCRIPTION_ENABLED` (구독 혜택 적용 on/off)

---

## 9) 현재 코드베이스와의 연결(참고)

### 9-1. 이미 있는 것
- 포인트(루비) 잔고/차감 인프라:
  - `backend-api/app/models/payment.py` (PaymentProduct/Payment/UserPoint/PointTransaction)
  - `backend-api/app/services/point_service.py` (Redis Lua 기반 원자 차감: `use_points_atomic`)
  - `backend-api/app/api/point.py` (잔고/차감/내역 API)
- 결제 API(현재는 데모 성격): `backend-api/app/api/payment.py`

### 9-2. 추가로 필요한 것(구현 작업 항목)
- “무료턴 잔고 + 대기 리필”을 저장/계산할 SSOT(권장: Redis + DB 백업 또는 DB만)
- 채팅 메시지 처리 지점에서 서버가 “턴/루비 차감”을 강제하는 로직
- 프론트에서 잔고/리필 상태를 보여줄 API(잔고 조회)

---

## 10) 배포 전 점검 체크리스트(결제/턴)

- [ ] 무료턴/대기리필/루비 차감이 **서버에서 강제**되는가(프론트 단독 X)
- [ ] 무료 플랜: 일 10턴 지급 + 3시간마다 +5 리필이 정상 동작하는가
- [ ] 구독 플랜: 일 10턴 지급 + 1시간마다 +10 리필이 정상 동작하는가
- [ ] 무료턴 cap이 적용되어 “무한 적립”이 발생하지 않는가
- [ ] 모델별 turn_cost가 의도대로 적용되는가(경쟁서비스식 세분화)
- [ ] 모델 호출 실패 시 차감 복구/보정이 가능한가(최소 로그/트랜잭션 보장)
- [ ] 구독자 “15% 할인”이 보너스 루비로 정확히 반영되는가
- [ ] 과도 호출/봇 방지를 위한 레이트 리밋이 있는가
- [ ] 운영 로그에서 “누가/언제/어떤 모델을/얼마나 차감했는지” 추적 가능한가

