1. 로그인 사용자 (Authenticated User)
1.1. 핵심 아키텍처: Stream Disconnect & Background Completion
원칙: 사용자는 한 번에 하나의 활성 스트리밍(SSE) 연결만 가질 수 있다.

동작:

새로운 생성 요청이 발생하면, 서버는 해당 유저의 기존 활성 SSE 연결을 즉시 종료시킨다.

서버는 연결이 끊긴 기존 생성 작업을 중단하지 않고, 백그라운드에서 끝까지 완료시킨다.

완료된 결과는 DB에 저장되며, 사용자가 해당 세션으로 복귀 시 완성된 데이터를 조회한다.

기대 효과: 이 아키텍처는 데이터 꼬임 현상을 원천적으로 방지하면서, 사용자가 느끼는 동시 작업 경험을 보장한다.

1.2. 생성 프로세스 및 API 명세
Phase 1: 프리뷰 생성 (최대 500자)
Request (Client → Server)

POST /api/v1/generate/preview

Body:

{
  "session_id": "session-uuid-123",
  "prompt": {
    "who": "마법사",
    "when": "고대 왕국",
    "where": "숨겨진 도서관",
    // ... 육하원칙 데이터
  }
}

Response (Server → Client)

202 Accepted

Body:

{
  "stream_id": "stream-uuid-abc"
}

서버는 이 stream_id에 대한 생성 작업을 백그라운드 큐에 등록한다.

SSE Connection (Client ↔ Server)

클라이언트는 받은 stream_id로 SSE 연결을 시작한다.

GET /api/v1/stream/{stream_id}

Stream Events:

event: message
data: {"type": "content", "text": "옛날 옛적에..."}

event: message
data: {"type": "content", "text": "한 마법사가..."}

event: done
data: {"type": "preview_complete", "canvas_task_id": "task-uuid-xyz"}

Phase 2: 캔버스 본문 생성 (501자 ~ 30,000자)
Request (Client → Server)

사용자가 '더보기'를 클릭하면 Phase 1에서 받은 canvas_task_id로 요청한다.

POST /api/v1/generate/canvas

Body:

{
  "canvas_task_id": "task-uuid-xyz"
}

Response (Server → Client)

202 Accepted

Body:

{
  "stream_id": "stream-uuid-def"
}

SSE Connection (Client ↔ Server)

GET /api/v1/stream/{stream_id}

Stream Events:

event: message
data: {"type": "content", "text": "도서관 깊은 곳에서..."}

event: done
data: {"type": "canvas_complete", "message": "Generation finished."}

1.3. 생성 중단 API
Request (Client → Server)

사용자가 중지 아이콘을 누르면 현재 활성 스트림 ID로 요청한다.

POST /api/v1/generate/stop

Body:

{
  "stream_id": "stream-uuid-abc"
}

Response (Server → Client)

200 OK

서버 동작: 해당 stream_id와 연결된 생성 작업을 즉시 종료하고, SSE 연결을 닫는다. DB에 결과를 저장하지 않는다.

1.4. 생성 상태(State) 정의
서버와 클라이언트는 다음 상태를 기준으로 생성 작업을 관리한다.

IDLE: 생성 작업이 없는 상태

PREVIEW_STREAMING: 프리뷰(500자) 스트리밍이 진행 중인 상태

AWAITING_CANVAS: 프리뷰가 완료되고 '더보기' 클릭을 대기하는 상태

CANVAS_STREAMING: 캔버스 본문 스트리밍이 진행 중인 상태

BACKGROUND_COMPLETING: 스트림 연결은 끊겼으나 서버에서 백그라운드 작업이 진행 중인 상태

COMPLETED: 모든 생성이 성공적으로 완료되어 DB에 저장된 상태

STOPPED: 사용자에 의해 중단된 상태

FAILED: 오류로 인해 실패한 상태

2. 게스트 계정 (Guest User)
인증: 클라이언트 최초 진입 시 서버에서 임시 guest_session_token을 발급받아 사용한다. 모든 API 요청 헤더에 이 토큰을 포함한다.

세션 관리: 서버는 guest_session_token을 기준으로 세션 데이터와 생성 횟수(최대 3회)를 관리한다.

UI 제한:

'새 대화' 버튼 비활성화 (disabled).

사이드패널의 히스토리, 보관함 컴포넌트 미표시 (display: none 또는 조건부 렌더링).

기능 잠금: 서버는 생성 횟수가 3회를 초과한 guest_session_token의 생성 관련 API(POST /api/v1/generate/*) 요청을 403 Forbidden 에러로 응답한다. 클라이언트는 이 응답을 받으면 전송 버튼을 비활성화한다.