/**
 * ✅ 자동생성 모드별 "톤/목표" 힌트(SSOT)
 *
 * 의도/원리:
 * - 시뮬레이션은 웹소설처럼 사건/목표/대가가 있어야 턴 기반 재미가 생긴다.
 * - 롤플레잉은 관계/호감도/일상 상호작용 중심이 자연스럽다.
 * - 같은 이미지(예: 교실/창가/교복/소녀)만으로는 모델이 안전한 "힐링 일상물"로 수렴하기 쉬워
 *   seed_text에 모드별 금지/필수 조건 + "소재 풀"을 제공해 다양성을 강제한다.
 *
 * 주의:
 * - 이 파일은 프론트에서 seed_text를 만드는 용도(LLM 안내)이며,
 *   실제 런타임 로직(턴 사건/엔딩 판정 등)을 직접 구현하는 곳이 아니다.
 */

/**
 * ✅ 시뮬레이션 소재/목표/대가 후보 풀(웹소설 감성)
 *
 * - 자동생성 시 LLM이 여기서 1~2개를 임의 선택해 "목표/훅"을 만들게 유도한다.
 * - 너무 길어지면 모델이 무시할 수 있으니, 각 항목은 짧고 선명하게 유지한다.
 */
export const SIMULATION_THEME_POOL = [
  // ✅ 학원물 외 대중 소재(현판/로판/판타지/스릴러/무협 등)를 넓게 포함한다.
  // - 배경(이미지 앵커)은 유지하되, "사건/목표/대가"의 소재는 다양하게 만들 수 있다.
  { theme: '타임루프', goal: '반복되는 장면을 끝낼 조건을 찾아라', stakes: '실패하면 중요한 것이 초기화된다' },
  { theme: '회귀', goal: '과거의 선택을 바꿔 파국을 막아라', stakes: '미래의 대가가 더 커진다' },
  { theme: '빙의/환생', goal: '원작(운명)을 비틀어 살아남아라', stakes: '정해진 사건이 강제로 닥친다' },
  { theme: '시스템/퀘스트', goal: '퀘스트를 완료해 목표를 달성하라', stakes: '실패 시 패널티가 누적된다' },
  { theme: '헌터/던전', goal: '각성의 단서를 찾아 첫 레이드를 성공하라', stakes: '정체가 들키면 표적이 된다' },
  { theme: '탑/게이트', goal: '조건을 충족해 다음 단계로 올라가라', stakes: '탈락하면 돌이킬 수 없다' },
  { theme: '아포칼립스', goal: '붕괴한 질서 속에서 생존 루트를 만들어라', stakes: '자원이 바닥나면 끝' },
  { theme: '도시괴담/규칙', goal: '금지 규칙과 근원을 추적하라', stakes: '규칙 위반 시 치명적 페널티' },
  { theme: '추리/미스터리', goal: '단서를 모아 진실을 밝혀라', stakes: '시간이 지날수록 증거가 사라진다' },
  { theme: '스릴러/감시', goal: '누가 보고 있는지 밝혀 위험을 끊어라', stakes: '발각되면 즉시 위험해진다' },
  { theme: '잠입/스파이', goal: '정체를 숨긴 채 임무를 완수하라', stakes: '정체가 들키면 모든 게 끝' },
  { theme: '비밀계약', goal: '제안된 계약의 목적을 완수하라', stakes: '대가를 치러야 한다' },
  { theme: '복수', goal: '가해자/조작자를 무너뜨릴 증거를 모아라', stakes: '한 번의 실수로 역공을 당한다' },
  { theme: '정치/권력전', goal: '동맹과 배신 속에서 판을 뒤집어라', stakes: '찍히면 퇴출/추방 위기' },
  { theme: '입시/경쟁', goal: '선발전에서 목표(합격/1등)를 쟁취하라', stakes: '평판/성적/관계가 무너진다' },
  { theme: '연예계/아이돌', goal: '데뷔/오디션을 통과해 무대에 올라라', stakes: '스캔들 한 번이면 끝' },
  { theme: '재벌/오피스', goal: '권력의 룰을 읽고 목표를 빼앗아라', stakes: '약점이 잡히면 퇴장' },
  { theme: '법정/수사', goal: '사건의 모순을 찾아 무죄/진실을 증명하라', stakes: '기한을 넘기면 패배' },
  { theme: '무협/강호', goal: '비급/원한의 실마리를 찾아 돌파하라', stakes: '강호의 규율이 족쇄가 된다' },
  { theme: '마법/아카나', goal: '금지된 마법의 대가를 견뎌 진실에 닿아라', stakes: '사용할수록 대가가 커진다' },
  { theme: '초능력 각성', goal: '능력의 규칙을 통제하고 비밀을 지켜라', stakes: '발각되면 실험 대상이 된다' },
  { theme: '관계 심리전', goal: '신뢰를 쌓아 핵심 정보를 얻어라', stakes: '관계가 깨지면 루트가 닫힌다' },
  { theme: '메타/게임화', goal: '선택 누적의 규칙을 이용해 최적의 결말로 가라', stakes: '실수하면 되돌릴 수 없다' },

  // ✅ 캐릭터챗 커뮤니티/플랫폼에서 자주 소비되는 "시뮬 소재" 축(학원 고정 아님)
  // - (아카라이브 AI채팅/CYOA, 각종 캐챗 플랫폼)에서 흔한 카테고리/상황극을 목표/대가로 정리
  { theme: 'CYOA/분기형 모험', goal: '선택지를 통해 루트를 개척하고 결말을 만들어라', stakes: '잘못된 선택은 루트가 닫힌다' },
  { theme: '다인 시뮬(파티/동료)', goal: '여러 인물/세력의 이해관계를 조율해 목표를 달성하라', stakes: '갈등이 폭발하면 동료가 이탈한다' },
  { theme: '연애 시뮬(미연시)', goal: '호감도/이벤트를 관리해 특정 엔딩에 도달하라', stakes: '호감도 하락 시 배드엔딩 루트' },
  { theme: '소개팅/데이트 시뮬', goal: '대화 선택으로 관계의 방향을 결정하라', stakes: '실수하면 즉시 이탈/차단' },
  { theme: '저택/메이드·집사', goal: '저택의 비밀과 규칙을 파악해 위기를 넘겨라', stakes: '규칙을 어기면 쫓겨난다' },
  { theme: '무인도/조난', goal: '자원과 동료를 관리해 탈출 루트를 만들어라', stakes: '자원 고갈로 실패' },
  { theme: '대체역사/정치극', goal: '역사의 분기점을 바꿔 목표를 성취하라', stakes: '선택이 전쟁/붕괴로 이어진다' },
  { theme: '우주/외계 생존', goal: '낯선 환경의 규칙을 파악하고 귀환하라', stakes: '오류 한 번이면 치명상' },
  { theme: '관리/운영 시뮬', goal: '시설/조직을 운영해 붕괴를 막아라', stakes: '지표가 무너지면 게임오버' },
  { theme: '경쟁/랭크전', goal: '랭크/점수를 올려 정상에 올라라', stakes: '패배가 누적되면 기회가 사라진다' },
  { theme: '프로게이머/스포츠', goal: '팀을 이끌어 우승을 달성하라', stakes: '부상/멘탈 붕괴로 시즌 종료' },
  { theme: '요리/장사 성장', goal: '레시피/고객/평판을 확보해 성공하라', stakes: '평판 하락 시 폐업' },
  { theme: '검문/탈출(감금/감시)', goal: '감시망을 뚫고 탈출/역전의 증거를 모아라', stakes: '발각되면 즉시 제압' },
  { theme: '범죄/잠입 작전', goal: '고위험 작전을 성공시키고 흔적을 지워라', stakes: '한 번의 실수로 전면 수배' },
  { theme: '폐쇄공간(열차/호텔/학교)', goal: '폐쇄된 공간의 규칙과 진범을 찾아 탈출하라', stakes: '시간 제한 내 실패 시 배드엔딩' },
  { theme: '세력전(길드/파벌)', goal: '세력을 키워 전면전을 승리로 이끌어라', stakes: '자원/신뢰 붕괴로 몰락' },
];

function buildSimulationThemeBlock() {
  const lines = SIMULATION_THEME_POOL.map((x) => `- ${x.theme}: 목표=${x.goal} / 대가=${x.stakes}`);
  return [
    '다음 "소재/목표/대가" 후보 중 1~2개를 임의 선택해 이번 생성에 반영하라. (매 시도마다 가능하면 다른 소재를 선택)',
    '중요: 이미지 앵커(장면/분위기)는 존중하되, 소재는 학원물에 고정하지 말고 다양하게 재해석하라.',
    lines.join('\n'),
  ].join('\n');
}

/**
 * ✅ seed_text에 넣을 모드별 힌트 문구를 만든다.
 *
 * @param {Object} params
 * @param {'roleplay'|'simulator'|'custom'} params.mode
 * @param {boolean} [params.isDescription] - 한줄소개 생성 단계 여부
 */
export function buildAutoGenModeHint({ mode, isDescription = false } = {}) {
  if (mode === 'simulator') {
    return [
      '시뮬레이션(웹소설 스토리) 모드다. "따뜻한 일상물만"으로 끝내지 말고, 초반부터 사건/목표/훅이 느껴져야 한다.',
      buildSimulationThemeBlock(),
      isDescription
        ? '한줄소개에는 ① 주인공 목표 1개 ② 갈등/규칙/비밀 중 1개 ③ 선택이 결말을 바꾼다는 느낌 ④ 리스크/대가 1개를 포함하라.'
        : '작품명은 위 소재/목표/대가 중 핵심 이미지를 반영해 제목형으로 만든다. (힐링/일상만 연상되는 제목 금지)',
      '금지: 힐링 일상만, 단순 소개만, 대화 유도 문구(“대화해요/함께해요”), 키워드 목록 나열, 시스템 설명',
    ].join('\n');
  }
  if (mode === 'custom') {
    return '커스텀 모드다. 특정 장르로 과도하게 몰지 말고, 이미지/선택값에 근거한 중립적 콘셉트로 생성하라.';
  }
  // roleplay
  return [
    // ✅ 페르소나(요구사항): 한국 캐릭터챗 시장 톤/후킹을 강하게 고정
    '너는 한국 캐릭터챗 플랫폼에서 업계탑급 인기 캐릭터챗 크리에이터다. 남성향/여성향 유저에게 맞는 롤플레잉 캐릭터챗을 위한 제목과 한줄소개를, 아래 선택 소재를 근거로 시장성 있게 창작하라.',
    '롤플레잉(관계/호감도 중심) 모드다. 일상 상호작용/감정선/관계의 거리감을 중심으로 설계하라.',
    isDescription
      ? [
        '한줄소개에는 관계의 갈등/호감도/금기/질투/오해/구원/헌신/재회 중 1~2개를 넣되, 사건 전개(추리/생존)로 과도하게 치우치지 마라.',
        '중요: 가능하면 "계약/약속/거래/비밀" 단어에만 의존하지 말고, 같은 의미라도 더 구체적인 상황/행동/관계 훅으로 표현하라.',
        '중요: 그래도 "계약/약속/거래"를 쓰는 경우에는 문장 안에서 무엇을 건/대가/기간 중 최소 1개가 드러나게 구체화하라. (추상적으로 끝내지 말기)',
      ].join('\n')
      : [
        /**
         * ✅ RP 작품명 규칙(요구사항)
         *
         * 배경:
         * - 크랙/바베챗 RP 작품명은 캐릭터의 '고유명사(이름)'가 그대로 노출되는 비중이 높다.
         * - 따라서 RP에서는 작품명에 캐릭터 이름이 반드시 보이도록 강제해야 유저 기대와 맞는다.
         *
         * 원칙:
         * - 이름만으로 끝내도 되지만(짧게 나오는 경우가 많음), UI 제약/후킹을 위해
         *   필요하면 "이름 + 짧은 수식(직업/관계/거리감/금기)" 형태로 확장한다.
         */
        '중요: 롤플레잉 작품명(name)은 캐릭터의 이름(고유명사)이 반드시 직접 보이게 만들어라. (예: 이름 단독 또는 "이름 + 짧은 수식" 형태)',
        '금지: "아카데미/학교/도시/세계/시뮬레이션" 같은 세계관/장소 제목만으로 작품명을 만들지 마라. (롤플레잉은 캐릭터 이름이 제목에 반드시 포함되어야 한다)',
        '중요: 가능하면 "계약/약속/거래/비밀" 단어를 제목의 핵심 훅으로 쓰지 말고, 더 강한 행위/상황 훅(예: 낙인, 협박, 감시, 구속, 도망, 은폐, 동거, 구애, 복수)으로 치환하라.',
        '중요: 그래도 "계약/약속/거래"를 쓰면, 제목만 봐도 무엇을 건/대가/기간 중 최소 1개가 드러나게 구체화하라. (예: "3년 복종 계약", "가짜 약혼 계약", "목숨값 거래")',
        '작품명은 관계 중심의 분위기(설렘/거리감/금기/약속)를 떠올리게 하되, 과도한 사건 장르로 몰지 마라.',
      ].join('\n'),
    '금지: 시스템 설명, 키워드 나열, 대화 유도 문구(“대화해요/함께해요”)',
  ].join('\n');
}

/**
 * ✅ 자동생성 "톤 프리셋" 힌트(SSOT)
 *
 * 의도/원리:
 * - 유저가 태그를 수십 개 고르는 상황에서, 태그별로 사람이 규칙을 직접 쓰는 방식은 스케일이 안 난다.
 * - 따라서 자주 쓰는 분위기(순애/일상/힐링/피폐/혐관)를 "프리셋"으로 SSOT화하고,
 *   선택된 태그/훅에서 자동으로 1~2개를 뽑아 seed_text에 짧게 주입한다.
 *
 * 주의:
 * - 태그의 본질(뼈대)을 바꾸지 않는다. "표현/후킹/프레이밍"만 조절한다.
 * - 금지/강제는 최소로 유지하고, 특히 로맨스 태그가 있을 때 '통제/감시'로만 수렴하는 드리프트를 방지한다.
 */
const AUTO_TONE_PRESETS = [
  {
    id: 'romance_pure',
    label: '순애/로맨스',
    keywords: ['순애', '로맨스', '연애', '설렘', '달달', '고백', '헌신', '첫사랑', '재회'],
    must: [
      '관계의 안전감/선택권/배려가 문장으로 1회 이상 분명히 드러나게 하라.',
      '감정선은 "행동/상황"으로 보여라(추상적 감성문장만 금지).',
    ],
    antiDrift: [
      '금지: 감시/통제/거래/협박만으로 후킹을 끝내기. (로맨스 태그가 있으면 반드시 관계 결이 먼저 체감되어야 함)',
    ],
  },
  {
    id: 'slice_of_life',
    label: '일상',
    keywords: ['일상', '루틴', '동거', '친구', '학원', '학교', '오피스', '직장', '동아리'],
    must: [
      '하루의 루틴/공간 디테일 1개 + 관계의 작은 변화 1개를 포함하라.',
    ],
    antiDrift: [
      '금지: 세계관/설정 설명으로 길게 깔기. (일상은 상황 디테일로 밀도 확보)',
    ],
  },
  {
    id: 'academy_school',
    label: '학교/아카데미/청춘',
    keywords: ['학교', '학원', '아카데미', '고등학교', '고등학생', '대학생', '학생', '학생회장', '교복', '청춘', '과제', '동아리'],
    must: [
      '배경 규칙(서열/평가/규정/선발전/소문) 중 1개를 명시하고, 그 규칙이 관계/선택에 미치는 영향 1개를 포함하라.',
      '장면 디테일(교실/복도/동아리방/과제/체육관 등) 1개를 포함하라.',
    ],
    antiDrift: [
      '금지: 학원물이라면서 세계관 설명만 길게. (학교/아카데미는 "규칙+장면"이 핵심)',
    ],
  },
  {
    id: 'healing',
    label: '힐링/치유',
    keywords: ['힐링', '치유', '따뜻', '잔잔', '위로', '포근', '안정', '휴식', '회복'],
    must: [
      '상대가 "무엇을 견뎌왔고" 무엇으로 회복되는지(행동/장면) 1개를 넣어라.',
    ],
    antiDrift: [
      '금지: 위로/힐링을 말로만 선언하기. (장면/행동으로 증명)',
    ],
  },
  {
    id: 'game_sim',
    label: '게임/시뮬(플레이 루프)',
    keywords: [
      '시뮬레이션', '시뮬레이터', '게임', '텍스트게임', 'RPG', 'TRPG', '오픈월드', '방탈출',
      '퀘스트', '미션', '루트', '이벤트', '분기', '멀티엔딩', '턴제', '시간제한', '패널티',
      '스탯', '스킬', '강화', '아이템', '수집', '상점',
      '주사위', '확률', '랭킹', '승급', '레이드', '보스전',
      '히든직업', '각성', '게이트', '길드',
      '회귀', '빙의', '환생', '전생', '타임루프',
    ],
    must: [
      '한줄소개/요약에 "목표 1개 + 규칙/제약 1개 + 리스크/대가 1개"가 반드시 드러나게 하라.',
      '선택/분기(플레이 루프)가 느껴지는 문장을 최소 1개 포함하라. (예: 선택에 따라 결말/보상이 달라진다)',
    ],
    antiDrift: [
      '금지: 시스템 용어만 나열. (반드시 "상황 문장" 안에서 규칙이 작동해야 함)',
    ],
  },
  {
    id: 'dark',
    label: '피폐/우울',
    keywords: ['피폐', '우울', '파멸', '트라우마', '멘헤라', '상처', '금단', '집착', '광기'],
    must: [
      '갈등의 대가/상처(리스크)를 1문장에 구체적으로 명시하라.',
    ],
    antiDrift: [
      '금지: 고어/잔혹 디테일 과다(선정성/폭력성 폭주). 핵심은 정서적 압박/관계 왜곡이다.',
    ],
  },
  {
    id: 'enemies',
    label: '혐관/대립',
    keywords: ['혐관', '앙숙', '라이벌', '대립', '증오', '복수', '신경전', '견제'],
    must: [
      '서로 왜 싫은지/부딪히는 규칙(이익/원칙/과거) 1개를 명시하라.',
      '혐관이어도 관계의 "긴장 리듬"(가까워짐/멀어짐 조건) 1개를 넣어라.',
    ],
    antiDrift: [
      '금지: 이유 없는 폭언/폭력. 갈등은 "규칙/이익/과거"로 설득력 있게.',
    ],
  },
  {
    id: 'idol_stream',
    label: '방송/아이돌/팬덤',
    keywords: ['아이돌', '매니저', '스트리머', '유튜버', '인플루언서', '방송인', '버튜버', '팬', '연예인/팬'],
    must: [
      '공개/사생활(스캔들/평판/팬덤/라이브) 중 1개를 리스크 또는 갈등으로 명시하라.',
      '무대/방송/연습실/촬영장 등 "장소 디테일" 1개를 포함하라.',
    ],
    antiDrift: [
      '금지: “연예인이라 바쁘다” 같은 추상 소개만. (평판/팬덤/라이브의 규칙이 실제로 걸려야 함)',
    ],
  },
  {
    id: 'hero_villain',
    label: '히어로/빌런/변신',
    keywords: ['히어로', '빌런', '레인저', '마법소녀', '악의조직', '정의', '전투', '작전', '임무'],
    must: [
      '역할(히어로/빌런)과 정체/임무(또는 금기) 1개를 명시하라.',
      '대립 구도(추격/잠입/구출/봉쇄 등) 중 1개를 "행동"으로 보여라.',
    ],
    antiDrift: [
      '금지: 설정 설명만으로 끝내기. (반드시 “오늘 당장 벌어지는 임무/충돌”이 느껴져야 함)',
    ],
  },
];

function _normalizeTags(tags) {
  try {
    const arr = Array.isArray(tags) ? tags : [];
    return arr
      .map((x) => String(x || '').trim())
      .filter(Boolean);
  } catch (_) {
    return [];
  }
}

function _scoreTonePreset(preset, tagList) {
  try {
    const keys = Array.isArray(preset?.keywords) ? preset.keywords : [];
    if (!keys.length) return 0;
    let s = 0;
    for (const t of tagList) {
      for (const k of keys) {
        if (t === k) s += 3;
        else if (t.includes(k) || k.includes(t)) s += 1;
      }
    }
    return s;
  } catch (_) {
    return 0;
  }
}

function _pickTopTonePresets(tagList, { maxCount = 2 } = {}) {
  /**
   * ✅ 태그 기반 톤 프리셋 자동 선택(방어적)
   *
   * - 점수 기반으로 1~2개만 뽑는다(너무 많이 주입하면 모델이 무시하거나 산만해짐).
   * - 점수가 0이면 빈 배열(톤 강제 X).
   */
  try {
    const scored = AUTO_TONE_PRESETS
      .map((p) => ({ p, score: _scoreTonePreset(p, tagList) }))
      .filter((x) => (x?.score || 0) > 0)
      .sort((a, b) => (b.score || 0) - (a.score || 0));
    const out = [];
    for (const x of scored) {
      if (!x?.p?.id) continue;
      out.push(x.p);
      if (out.length >= Math.max(1, Math.floor(maxCount))) break;
    }
    return out;
  } catch (_) {
    return [];
  }
}

export function buildAutoGenToneHint({ tags, mode, audienceSlug, isDescription = false } = {}) {
  /**
   * ✅ seed_text에 넣을 "톤 프리셋" 힌트를 만든다.
   *
   * - 목적: "순애/일상/힐링/피폐/혐관" 같은 분위기를 사람이 매번 규칙으로 쓰지 않게 한다.
   * - 방식: 태그에서 1~2개 프리셋을 자동 선택 → 프리셋의 must/antiDrift를 짧게 주입.
   */
  try {
    const tagList = _normalizeTags(tags);
    const picks = _pickTopTonePresets(tagList, { maxCount: 2 });
    if (!picks.length) return '';

    const a = String(audienceSlug || '').trim();
    const m = String(mode || '').trim();
    const header = [
      '중요(톤 프리셋 자동 적용): 아래 분위기를 우선 반영하라. (태그 본질은 유지, 표현/프레이밍만 조절)',
      picks.map((p) => `- ${p.label}`).join('\n'),
      a ? `성향 테이스트: ${a}` : null,
      m ? `모드: ${m}` : null,
    ].filter(Boolean).join('\n');

    // ✅ 로맨스 태그가 있을 때 "감시/통제" 수렴 방지용 공통 규칙(핵심)
    const hasRomance = picks.some((p) => p.id === 'romance_pure');
    const consentRule = hasRomance
      ? [
        '드리프트 방지(핵심): 감시/권력/거래/비밀 소재가 있어도, 로맨스 톤에서는 "합의/선택권/자기 억제/보호" 프레이밍으로 풀어라. (강압만으로 밀지 마)',
        isDescription
          ? '한줄소개에는 "상호 선택/배려/안전감"이 실제 문장으로 1회 이상 포함되어야 한다.'
          : null,
      ].filter(Boolean).join('\n')
      : '';

    const mustLines = picks
      .flatMap((p) => (Array.isArray(p.must) ? p.must : []))
      .filter(Boolean)
      .map((s) => `- ${s}`)
      .join('\n');
    const antiLines = picks
      .flatMap((p) => (Array.isArray(p.antiDrift) ? p.antiDrift : []))
      .filter(Boolean)
      .map((s) => `- ${s}`)
      .join('\n');    return [
      header,
      mustLines ? ['필수 구현:', mustLines].join('\n') : null,
      antiLines ? ['금지/드리프트 방지:', antiLines].join('\n') : null,
      consentRule || null,
    ].filter(Boolean).join('\n');
  } catch (_) {
    return '';
  }
}